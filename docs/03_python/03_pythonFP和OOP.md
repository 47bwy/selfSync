# 

é¢å‘å‡½æ•°ç¼–ç¨‹ï¼ˆFunctional Programmingï¼ŒFPï¼‰

ğŸŒŸ æ ¸å¿ƒæ€æƒ³ï¼š

ç¨‹åºæ˜¯ç”±çº¯å‡½æ•°ç»„æˆçš„ï¼Œä¸ä¾èµ–å’Œä¿®æ”¹å…¨å±€çŠ¶æ€ï¼Œå¼ºè°ƒå‡½æ•°å³ä¸€ç­‰å…¬æ°‘ï¼ˆå‡½æ•°å¯ä»¥ä½œä¸ºå‚æ•°ã€è¿”å›å€¼ã€èµ‹å€¼ç­‰ï¼‰ã€‚

ğŸ§© ç‰¹å¾ï¼š

| ç‰¹å¾     | è¯´æ˜                                                         |
| -------- | ------------------------------------------------------------ |
| çº¯å‡½æ•°   | æ— å‰¯ä½œç”¨ï¼Œç›¸åŒè¾“å…¥æ°¸è¿œäº§ç”Ÿç›¸åŒè¾“å‡º                           |
| ä¸å¯å˜æ€§ | é¿å…ä¿®æ”¹çŠ¶æ€ï¼Œå˜é‡å°½é‡ä¸å˜                                   |
| é«˜é˜¶å‡½æ•° | æ¥æ”¶å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œæˆ–è¿”å›å‡½æ•°                                 |
| å‡½æ•°ç»„åˆ | å‡½æ•°åµŒå¥—ä½¿ç”¨ï¼Œå½¢æˆç®¡é“å¼æµç¨‹ï¼ˆå¦‚ `map`ã€`filter`ã€`reduce`ï¼‰ |



é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ˆObject-Oriented Programmingï¼ŒOOPï¼‰

ğŸŒŸ æ ¸å¿ƒæ€æƒ³ï¼š

å°†æ•°æ®å’Œæ“ä½œæ•°æ®çš„**æ–¹æ³•å°è£…åœ¨ä¸€èµ·**ï¼Œé€šè¿‡â€œå¯¹è±¡â€æ¥ç»„ç»‡ç¨‹åºç»“æ„ã€‚å¼ºè°ƒâ€œ**å¯¹è±¡å³å®ä½“**â€ã€‚

ğŸ§© åŸºæœ¬æ¦‚å¿µï¼š

| æ¦‚å¿µ           | è¯´æ˜                                   |
| -------------- | -------------------------------------- |
| ç±»ï¼ˆClassï¼‰    | æ¨¡æ¿æˆ–è“å›¾ï¼Œå®šä¹‰å¯¹è±¡çš„å±æ€§å’Œè¡Œä¸º       |
| å¯¹è±¡ï¼ˆObjectï¼‰ | ç±»çš„å®ä¾‹ï¼Œè¡¨ç¤ºå®é™…å­˜åœ¨çš„å®ä½“           |
| å°è£…           | æŠŠæ•°æ®å’Œæ–¹æ³•ç»‘å®šåˆ°ä¸€èµ·ï¼Œéšè—å†…éƒ¨å®ç°   |
| ç»§æ‰¿           | å­ç±»ç»§æ‰¿çˆ¶ç±»çš„å±æ€§å’Œæ–¹æ³•ï¼Œä»£ç å¤ç”¨     |
| å¤šæ€           | ä¸åŒå¯¹è±¡å¯ä»¥è°ƒç”¨åŒä¸€æ¥å£ï¼Œå®ç°ä¸åŒåŠŸèƒ½ |



ğŸ” å¯¹æ¯”æ€»ç»“ï¼š

| ç‰¹ç‚¹     | OOP                               | FP                                 |
| -------- | --------------------------------- | ---------------------------------- |
| ç¼–ç¨‹æ–¹å¼ | åŸºäºå¯¹è±¡                          | åŸºäºå‡½æ•°                           |
| çŠ¶æ€ç®¡ç† | å€¾å‘äºå¯å˜çŠ¶æ€                    | å€¾å‘äºä¸å¯å˜                       |
| æŠ½è±¡ç„¦ç‚¹ | å®ä½“ï¼ˆå¯¹è±¡ï¼‰                      | è¡Œä¸ºï¼ˆå‡½æ•°ï¼‰                       |
| é€‚ç”¨åœºæ™¯ | GUIã€æ¸¸æˆå¼€å‘ã€éœ€è¦ç®¡ç†çŠ¶æ€çš„ç³»ç»Ÿ | æ•°æ®å¤„ç†ã€å¹¶å‘è®¡ç®—ã€é€»è¾‘æ¸…æ™°çš„ä»»åŠ¡ |
| ä»£ç ç»“æ„ | æ›´åç»“æ„åŒ–                        | æ›´åæµç¨‹åŒ–                         |



### ğŸ å‡½æ•°

#### ğŸ¯ å¯æ¥å—ä»»æ„æ•°é‡å‚æ•°çš„å‡½æ•°
ä¸ºäº†èƒ½è®©ä¸€ä¸ªå‡½æ•°æ¥å—ä»»æ„æ•°é‡çš„ä½ç½®å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ª*å‚æ•°ã€‚ä¾‹å¦‚ï¼š
```python
def avg(first, *rest):
    return (first + sum(rest)) / (1 + len(rest))

# Sample use
avg(1, 2) # 1.5
avg(1, 2, 3, 4) # 2.5
```

ä¸ºäº†æ¥å—ä»»æ„æ•°é‡çš„å…³é”®å­—å‚æ•°ï¼Œä½¿ç”¨ä¸€ä¸ªä»¥**å¼€å¤´çš„å‚æ•°ã€‚æ¯”å¦‚ï¼š
```python
import html

def make_element(name, value, **attrs):
    keyvals = [' %s="%s"' % item for item in attrs.items()]
    attr_str = ''.join(keyvals)
    element = '<{name}{attrs}>{value}</{name}>'.format(
                name=name,
                attrs=attr_str,
                value=html.escape(value))
    return element

# Example
# Creates '<item size="large" quantity="6">Albatross</item>'
make_element('item', 'Albatross', size='large', quantity=6)

# Creates '<p>&lt;spam&gt;</p>'
make_element('p', '<spam>')
```
åœ¨è¿™é‡Œï¼Œattrsæ˜¯ä¸€ä¸ªåŒ…å«æ‰€æœ‰è¢«ä¼ å…¥è¿›æ¥çš„å…³é”®å­—å‚æ•°çš„å­—å…¸ã€‚

å¦‚æœè¿˜å¸Œæœ›æŸä¸ªå‡½æ•°èƒ½åŒæ—¶æ¥å—ä»»æ„æ•°é‡çš„ä½ç½®å‚æ•°å’Œå…³é”®å­—å‚æ•°ï¼Œå¯ä»¥åŒæ—¶ä½¿ç”¨*å’Œ**ã€‚æ¯”å¦‚ï¼š
```python
def anyargs(*args, **kwargs):
    print(args) # A tuple
    print(kwargs) # A dict
```

ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œæ‰€æœ‰ä½ç½®å‚æ•°ä¼šè¢«æ”¾åˆ°argså…ƒç»„ä¸­ï¼Œæ‰€æœ‰å…³é”®å­—å‚æ•°ä¼šè¢«æ”¾åˆ°å­—å…¸kwargsä¸­ã€‚


#### ğŸ¯ åªæ¥å—å…³é”®å­—å‚æ•°çš„å‡½æ•°
å¸Œæœ›å‡½æ•°çš„æŸäº›å‚æ•°å¼ºåˆ¶ä½¿ç”¨å…³é”®å­—å‚æ•°ä¼ é€’ï¼Œå°†å¼ºåˆ¶å…³é”®å­—å‚æ•°æ”¾åˆ°æŸä¸ª*å‚æ•°æˆ–è€…å•ä¸ª*åé¢å°±èƒ½è¾¾åˆ°è¿™ç§æ•ˆæœã€‚æ¯”å¦‚ï¼š
```python
def recv(maxsize, *, block):
    'Receives a message'
    pass

recv(1024, True) # TypeError
recv(1024, block=True) # Ok
```
åˆ©ç”¨è¿™ç§æŠ€æœ¯ï¼Œæˆ‘ä»¬è¿˜èƒ½åœ¨æ¥å—ä»»æ„å¤šä¸ªä½ç½®å‚æ•°çš„å‡½æ•°ä¸­æŒ‡å®šå…³é”®å­—å‚æ•°ã€‚æ¯”å¦‚ï¼š
```python
def minimum(*values, clip=None):
    m = min(values)
    if clip is not None:
        m = clip if clip > m else m
    return m

minimum(1, 5, 2, -5, 10) # Returns -5
minimum(1, 5, 2, -5, 10, clip=0) # Returns 0
```
å¾ˆå¤šæƒ…å†µä¸‹ï¼Œä½¿ç”¨å¼ºåˆ¶å…³é”®å­—å‚æ•°ä¼šæ¯”ä½¿ç”¨ä½ç½®å‚æ•°è¡¨æ„æ›´åŠ æ¸…æ™°ï¼Œç¨‹åºä¹Ÿæ›´åŠ å…·æœ‰å¯è¯»æ€§ã€‚ ä¾‹å¦‚ï¼Œè€ƒè™‘ä¸‹å¦‚ä¸‹ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼š
```python
msg = recv(1024, False)
```
å¦‚æœè°ƒç”¨è€…å¯¹recvå‡½æ•°å¹¶ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œé‚£ä»–è‚¯å®šä¸æ˜ç™½é‚£ä¸ªFalseå‚æ•°åˆ°åº•æ¥å¹²å˜›ç”¨çš„ã€‚ ä½†æ˜¯ï¼Œå¦‚æœä»£ç å˜æˆä¸‹é¢è¿™æ ·å­çš„è¯å°±æ¸…æ¥šå¤šäº†ï¼š
```python
msg = recv(1024, block=False)
```
å¦å¤–ï¼Œä½¿ç”¨å¼ºåˆ¶å…³é”®å­—å‚æ•°ä¹Ÿä¼šæ¯”ä½¿ç”¨**kwargså‚æ•°æ›´å¥½ï¼Œå› ä¸ºåœ¨ä½¿ç”¨å‡½æ•°helpçš„æ—¶å€™è¾“å‡ºä¹Ÿä¼šæ›´å®¹æ˜“ç†è§£ï¼š
```python
>>> help(recv)
Help on function recv in module __main__:
recv(maxsize, *, block)
    Receives a message
```
å¼ºåˆ¶å…³é”®å­—å‚æ•°åœ¨ä¸€äº›æ›´é«˜çº§åœºåˆåŒæ ·ä¹Ÿå¾ˆæœ‰ç”¨ã€‚ ä¾‹å¦‚ï¼Œå®ƒä»¬å¯ä»¥è¢«ç”¨æ¥åœ¨ä½¿ç”¨*argså’Œ**kwargså‚æ•°ä½œä¸ºè¾“å…¥çš„å‡½æ•°ä¸­æ’å…¥å‚æ•°ã€‚

#### ğŸ¯ ç»™å‡½æ•°å‚æ•°å¢åŠ å…ƒä¿¡æ¯
å†™å¥½äº†ä¸€ä¸ªå‡½æ•°ï¼Œç„¶åæƒ³ä¸ºè¿™ä¸ªå‡½æ•°çš„å‚æ•°å¢åŠ ä¸€äº›é¢å¤–çš„ä¿¡æ¯ï¼Œè¿™æ ·çš„è¯å…¶ä»–ä½¿ç”¨è€…å°±èƒ½æ¸…æ¥šçš„çŸ¥é“è¿™ä¸ªå‡½æ•°åº”è¯¥æ€ä¹ˆä½¿ç”¨ã€‚

ä½¿ç”¨å‡½æ•°å‚æ•°æ³¨è§£æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åŠæ³•ï¼Œå®ƒèƒ½æç¤ºç¨‹åºå‘˜åº”è¯¥æ€æ ·æ­£ç¡®ä½¿ç”¨è¿™ä¸ªå‡½æ•°ã€‚ ä¾‹å¦‚ï¼Œä¸‹é¢æœ‰ä¸€ä¸ªè¢«æ³¨è§£äº†çš„å‡½æ•°ï¼š
```python
def add(x:int, y:int) -> int:
    return x + y
```
pythonè§£é‡Šå™¨ä¸ä¼šå¯¹è¿™äº›æ³¨è§£æ·»åŠ ä»»ä½•çš„è¯­ä¹‰ã€‚å®ƒä»¬ä¸ä¼šè¢«ç±»å‹æ£€æŸ¥ï¼Œè¿è¡Œæ—¶è·Ÿæ²¡æœ‰åŠ æ³¨è§£ä¹‹å‰çš„æ•ˆæœä¹Ÿæ²¡æœ‰ä»»ä½•å·®è·ã€‚ ç„¶è€Œï¼Œå¯¹äºé‚£äº›é˜…è¯»æºç çš„äººæ¥è®²å°±å¾ˆæœ‰å¸®åŠ©å•¦ã€‚ç¬¬ä¸‰æ–¹å·¥å…·å’Œæ¡†æ¶å¯èƒ½ä¼šå¯¹è¿™äº›æ³¨è§£æ·»åŠ è¯­ä¹‰ã€‚åŒæ—¶å®ƒä»¬ä¹Ÿä¼šå‡ºç°åœ¨æ–‡æ¡£ä¸­ã€‚
```python
>>> help(add)
Help on function add in module __main__:
add(x: int, y: int) -> int
>>>
```
å°½ç®¡å¯ä»¥ä½¿ç”¨ä»»æ„ç±»å‹çš„å¯¹è±¡ç»™å‡½æ•°æ·»åŠ æ³¨è§£(ä¾‹å¦‚æ•°å­—ï¼Œå­—ç¬¦ä¸²ï¼Œå¯¹è±¡å®ä¾‹ç­‰ç­‰)ï¼Œä¸è¿‡é€šå¸¸æ¥è®²ä½¿ç”¨ç±»æˆ–è€…å­—ç¬¦ä¸²ä¼šæ¯”è¾ƒå¥½ç‚¹ã€‚

å‡½æ•°æ³¨è§£åªå­˜å‚¨åœ¨å‡½æ•°çš„ `__annotations__` å±æ€§ä¸­ã€‚ä¾‹å¦‚ï¼š
```python
>>> add.__annotations__
{'y': <class 'int'>, 'return': <class 'int'>, 'x': <class 'int'>}
```
å°½ç®¡æ³¨è§£çš„ä½¿ç”¨æ–¹æ³•å¯èƒ½æœ‰å¾ˆå¤šç§ï¼Œä½†æ˜¯å®ƒä»¬çš„ä¸»è¦ç”¨é€”è¿˜æ˜¯æ–‡æ¡£ã€‚ å› ä¸ºpythonå¹¶æ²¡æœ‰ç±»å‹å£°æ˜ï¼Œé€šå¸¸æ¥è®²ä»…ä»…é€šè¿‡é˜…è¯»æºç å¾ˆéš¾çŸ¥é“åº”è¯¥ä¼ é€’ä»€ä¹ˆæ ·çš„å‚æ•°ç»™è¿™ä¸ªå‡½æ•°ã€‚ è¿™æ—¶å€™ä½¿ç”¨æ³¨è§£å°±èƒ½ç»™ç¨‹åºå‘˜æ›´å¤šçš„æç¤ºï¼Œè®©ä»–ä»¬å¯ä»¥æ­£ç¡®çš„ä½¿ç”¨å‡½æ•°ã€‚


#### ğŸ¯ è¿”å›å¤šä¸ªå€¼çš„å‡½æ•°
ä¸ºäº†èƒ½è¿”å›å¤šä¸ªå€¼ï¼Œå‡½æ•°ç›´æ¥returnä¸€ä¸ªå…ƒç»„å°±è¡Œäº†ã€‚ä¾‹å¦‚ï¼š
```python
>>> def myfun():
... return 1, 2, 3
...
>>> a, b, c = myfun()
>>> a
1
>>> b
2
>>> c
3
```
å°½ç®¡`myfun()`çœ‹ä¸Šå»è¿”å›äº†å¤šä¸ªå€¼ï¼Œå®é™…ä¸Šæ˜¯å…ˆåˆ›å»ºäº†ä¸€ä¸ªå…ƒç»„ç„¶åè¿”å›çš„ã€‚ è¿™ä¸ªè¯­æ³•çœ‹ä¸Šå»æ¯”è¾ƒå¥‡æ€ªï¼Œå®é™…ä¸Šæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯é€—å·æ¥ç”Ÿæˆä¸€ä¸ªå…ƒç»„ï¼Œè€Œä¸æ˜¯ç”¨æ‹¬å·ã€‚æ¯”å¦‚ä¸‹é¢çš„ï¼š
```python
>>> a = (1, 2) # With parentheses
>>> a
(1, 2)
>>> b = 1, 2 # Without parentheses
>>> b
(1, 2)
>>>
```

#### ğŸ¯ å®šä¹‰æœ‰é»˜è®¤å‚æ•°çš„å‡½æ•°
å®šä¹‰ä¸€ä¸ªæœ‰å¯é€‰å‚æ•°çš„å‡½æ•°æ˜¯éå¸¸ç®€å•çš„ï¼Œç›´æ¥åœ¨å‡½æ•°å®šä¹‰ä¸­ç»™å‚æ•°æŒ‡å®šä¸€ä¸ªé»˜è®¤å€¼ï¼Œå¹¶æ”¾åˆ°å‚æ•°åˆ—è¡¨æœ€åå°±è¡Œäº†ã€‚ä¾‹å¦‚ï¼š
```python
def spam(a, b=42):
    print(a, b)

spam(1) # Ok. a=1, b=42
spam(1, 2) # Ok. a=1, b=2
```
å¦‚æœé»˜è®¤å‚æ•°æ˜¯ä¸€ä¸ªå¯ä¿®æ”¹çš„å®¹å™¨æ¯”å¦‚ä¸€ä¸ªåˆ—è¡¨ã€é›†åˆæˆ–è€…å­—å…¸ï¼Œå¯ä»¥ä½¿ç”¨Noneä½œä¸ºé»˜è®¤å€¼ï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š
```python
# Using a list as a default value
def spam(a, b=None):
    if b is None:
        b = []
    ...
```
å¦‚æœå¹¶ä¸æƒ³æä¾›ä¸€ä¸ªé»˜è®¤å€¼ï¼Œè€Œæ˜¯æƒ³ä»…ä»…æµ‹è¯•ä¸‹æŸä¸ªé»˜è®¤å‚æ•°æ˜¯ä¸æ˜¯æœ‰ä¼ é€’è¿›æ¥ï¼Œå¯ä»¥åƒä¸‹é¢è¿™æ ·å†™ï¼š
```python
_no_value = object()

def spam(a, b=_no_value):
    if b is _no_value:
        print('No b value supplied')
    ...

>>> spam(1)
No b value supplied
>>> spam(1, 2) # b = 2
>>> spam(1, None) # b = None
>>>
```
ä»”ç»†è§‚å¯Ÿå¯ä»¥å‘ç°åˆ°ä¼ é€’ä¸€ä¸ªNoneå€¼å’Œä¸ä¼ å€¼ä¸¤ç§æƒ…å†µæ˜¯æœ‰å·®åˆ«çš„ã€‚


å®šä¹‰å¸¦é»˜è®¤å€¼å‚æ•°çš„å‡½æ•°æ˜¯å¾ˆç®€å•çš„ï¼Œä½†ç»ä¸ä»…ä»…åªæ˜¯è¿™ä¸ªï¼Œè¿˜æœ‰ä¸€äº›ä¸œè¥¿åœ¨è¿™é‡Œä¹Ÿæ·±å…¥è®¨è®ºä¸‹ã€‚

é¦–å…ˆï¼Œé»˜è®¤å‚æ•°çš„å€¼ä»…ä»…åœ¨å‡½æ•°å®šä¹‰çš„æ—¶å€™èµ‹å€¼ä¸€æ¬¡ã€‚è¯•ç€è¿è¡Œä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š

```python
>>> x = 42
>>> def spam(a, b=x):
...     print(a, b)
...
>>> spam(1)
1 42
>>> x = 23 # Has no effect
>>> spam(1)
1 42
>>>
```

æ³¨æ„åˆ°å½“æˆ‘ä»¬æ”¹å˜xçš„å€¼çš„æ—¶å€™å¯¹é»˜è®¤å‚æ•°å€¼å¹¶æ²¡æœ‰å½±å“ï¼Œè¿™æ˜¯å› ä¸ºåœ¨å‡½æ•°å®šä¹‰çš„æ—¶å€™å°±å·²ç»ç¡®å®šäº†å®ƒçš„é»˜è®¤å€¼äº†ã€‚

å…¶æ¬¡ï¼Œé»˜è®¤å‚æ•°çš„å€¼åº”è¯¥æ˜¯ä¸å¯å˜çš„å¯¹è±¡ï¼Œæ¯”å¦‚Noneã€Trueã€Falseã€æ•°å­—æˆ–å­—ç¬¦ä¸²ã€‚ ç‰¹åˆ«çš„ï¼Œåƒä¸‡ä¸è¦åƒä¸‹é¢è¿™æ ·å†™ä»£ç ï¼š
```python
def spam(a, b=[]): # NO!
    ...
```
ä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œæœ€å¥½æ˜¯å°†é»˜è®¤å€¼è®¾ä¸ºNoneï¼Œ ç„¶ååœ¨å‡½æ•°é‡Œé¢æ£€æŸ¥å®ƒï¼Œåœ¨æµ‹è¯•Noneå€¼æ—¶ä½¿ç”¨ is æ“ä½œç¬¦æ˜¯å¾ˆé‡è¦çš„ï¼Œä¹Ÿæ˜¯è¿™ç§æ–¹æ¡ˆçš„å…³é”®ç‚¹ã€‚ 

#### ğŸ¯ å®šä¹‰åŒ¿åæˆ–å†…è”å‡½æ•°
ä¸º `sort()` æ“ä½œåˆ›å»ºä¸€ä¸ªå¾ˆçŸ­çš„å›è°ƒå‡½æ•°ï¼Œä½†åˆä¸æƒ³ç”¨ def å»å†™ä¸€ä¸ªå•è¡Œå‡½æ•°ï¼Œ è€Œæ˜¯å¸Œæœ›é€šè¿‡æŸä¸ªå¿«æ·æ–¹å¼ä»¥å†…è”æ–¹å¼æ¥åˆ›å»ºè¿™ä¸ªå‡½æ•°ã€‚

å½“ä¸€äº›å‡½æ•°å¾ˆç®€å•ï¼Œä»…ä»…åªæ˜¯è®¡ç®—ä¸€ä¸ªè¡¨è¾¾å¼çš„å€¼çš„æ—¶å€™ï¼Œå°±å¯ä»¥ä½¿ç”¨lambdaè¡¨è¾¾å¼æ¥ä»£æ›¿äº†ã€‚æ¯”å¦‚ï¼š
```python
>>> add = lambda x, y: x + y
>>> add(2,3)
5
>>> add('hello', 'world')
'helloworld'
>>>
```
`lambda`è¡¨è¾¾å¼å…¸å‹çš„ä½¿ç”¨åœºæ™¯æ˜¯æ’åºæˆ–æ•°æ®`reduce`ç­‰ï¼š
```python
>>> names = ['David Beazley', 'Brian Jones',
...         'Raymond Hettinger', 'Ned Batchelder']
>>> sorted(names, key=lambda name: name.split()[-1].lower())
['Ned Batchelder', 'David Beazley', 'Raymond Hettinger', 'Brian Jones']
>>>
```
å°½ç®¡`lambda`è¡¨è¾¾å¼å…è®¸å®šä¹‰ç®€å•å‡½æ•°ï¼Œä½†æ˜¯å®ƒçš„ä½¿ç”¨æ˜¯æœ‰é™åˆ¶çš„ã€‚ åªèƒ½æŒ‡å®šå•ä¸ªè¡¨è¾¾å¼ï¼Œå®ƒçš„å€¼å°±æ˜¯æœ€åçš„è¿”å›å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸èƒ½åŒ…å«å…¶ä»–çš„è¯­è¨€ç‰¹æ€§äº†ï¼Œ åŒ…æ‹¬å¤šä¸ªè¯­å¥ã€æ¡ä»¶è¡¨è¾¾å¼ã€è¿­ä»£ä»¥åŠå¼‚å¸¸å¤„ç†ç­‰ç­‰ã€‚

å¯ä»¥ä¸ä½¿ç”¨`lambda`è¡¨è¾¾å¼å°±èƒ½ç¼–å†™å¤§éƒ¨åˆ†pythonä»£ç ã€‚ ä½†æ˜¯ï¼Œå½“æœ‰äººç¼–å†™å¤§é‡è®¡ç®—è¡¨è¾¾å¼å€¼çš„çŸ­å°å‡½æ•°æˆ–è€…éœ€è¦ç”¨æˆ·æä¾›å›è°ƒå‡½æ•°çš„ç¨‹åºçš„æ—¶å€™ï¼Œ å°±ä¼šçœ‹åˆ°`lambda`è¡¨è¾¾å¼çš„èº«å½±äº†ã€‚



#### ğŸ¯ åŒ¿åå‡½æ•°æ•è·å˜é‡å€¼

ç”¨lambdaå®šä¹‰äº†ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œå¹¶æƒ³åœ¨å®šä¹‰æ—¶æ•è·åˆ°æŸäº›å˜é‡çš„å€¼ã€‚
```python
>>> x = 10
>>> a = lambda y: x + y
>>> x = 20
>>> b = lambda y: x + y
>>>
```
ç°åœ¨æˆ‘é—®ï¼Œa(10)å’Œb(10)è¿”å›çš„ç»“æœæ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœè®¤ä¸ºç»“æœæ˜¯20å’Œ30ï¼Œé‚£ä¹ˆå°±é”™äº†ï¼š
```python
>>> a(10)
30
>>> b(10)
30
>>>
```
è¿™å…¶ä¸­çš„å¥¥å¦™åœ¨äºlambdaè¡¨è¾¾å¼ä¸­çš„xæ˜¯ä¸€ä¸ªè‡ªç”±å˜é‡ï¼Œ åœ¨è¿è¡Œæ—¶ç»‘å®šå€¼ï¼Œè€Œä¸æ˜¯å®šä¹‰æ—¶å°±ç»‘å®šï¼Œè¿™è·Ÿå‡½æ•°çš„é»˜è®¤å€¼å‚æ•°å®šä¹‰æ˜¯ä¸åŒçš„ã€‚ å› æ­¤ï¼Œåœ¨è°ƒç”¨è¿™ä¸ªlambdaè¡¨è¾¾å¼çš„æ—¶å€™ï¼Œxçš„å€¼æ˜¯æ‰§è¡Œæ—¶çš„å€¼ã€‚ä¾‹å¦‚ï¼š
```python
>>> x = 15
>>> a(10)
25
>>> x = 3
>>> a(10)
13
>>>
```
å¦‚æœæƒ³è®©æŸä¸ªåŒ¿åå‡½æ•°åœ¨å®šä¹‰æ—¶å°±æ•è·åˆ°å€¼ï¼Œå¯ä»¥å°†é‚£ä¸ªå‚æ•°å€¼å®šä¹‰æˆé»˜è®¤å‚æ•°å³å¯ï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š
```python
>>> x = 10
>>> a = lambda y, x=x: x + y
>>> x = 20
>>> b = lambda y, x=x: x + y
>>> a(10)
20
>>> b(10)
30
>>>
```
åœ¨è¿™é‡Œåˆ—å‡ºæ¥çš„é—®é¢˜æ˜¯æ–°æ‰‹å¾ˆå®¹æ˜“çŠ¯çš„é”™è¯¯ï¼Œæœ‰äº›æ–°æ‰‹å¯èƒ½ä¼šä¸æ°å½“çš„ä½¿ç”¨lambdaè¡¨è¾¾å¼ã€‚ æ¯”å¦‚ï¼Œé€šè¿‡åœ¨ä¸€ä¸ªå¾ªç¯æˆ–åˆ—è¡¨æ¨å¯¼ä¸­åˆ›å»ºä¸€ä¸ªlambdaè¡¨è¾¾å¼åˆ—è¡¨ï¼Œå¹¶æœŸæœ›å‡½æ•°èƒ½åœ¨å®šä¹‰æ—¶å°±è®°ä½æ¯æ¬¡çš„è¿­ä»£å€¼ã€‚ä¾‹å¦‚ï¼š
```python
>>> funcs = [lambda x: x+n for n in range(5)]
>>> for f in funcs:
... print(f(0))
...
4
4
4
4
4
>>>
```
ä½†æ˜¯å®é™…æ•ˆæœæ˜¯è¿è¡Œæ˜¯nçš„å€¼ä¸ºè¿­ä»£çš„æœ€åä¸€ä¸ªå€¼ã€‚ç°åœ¨æˆ‘ä»¬ç”¨å¦ä¸€ç§æ–¹å¼ä¿®æ”¹ä¸€ä¸‹ï¼š
```python
>>> funcs = [lambda x, n=n: x+n for n in range(5)]
>>> for f in funcs:
... print(f(0))
...
0
1
2
3
4
>>>
```
é€šè¿‡ä½¿ç”¨å‡½æ•°é»˜è®¤å€¼å‚æ•°å½¢å¼ï¼Œlambdaå‡½æ•°åœ¨å®šä¹‰æ—¶å°±èƒ½ç»‘å®šåˆ°å€¼ã€‚(å› ä¸ºé»˜è®¤å€¼å‚æ•°åœ¨å®šä¹‰æ˜¯å°±ç¡®å®šäº†)


#### ğŸ¯ å‡å°‘å¯è°ƒç”¨å¯¹è±¡çš„å‚æ•°ä¸ªæ•°

æœ‰ä¸€ä¸ªè¢«å…¶ä»–pythonä»£ç ä½¿ç”¨çš„callableå¯¹è±¡ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°æˆ–è€…æ˜¯ä¸€ä¸ªå¤„ç†å™¨ï¼Œ ä½†æ˜¯å®ƒçš„å‚æ•°å¤ªå¤šäº†ï¼Œå¯¼è‡´è°ƒç”¨æ—¶å‡ºé”™ã€‚

å¦‚æœéœ€è¦å‡å°‘æŸä¸ªå‡½æ•°çš„å‚æ•°ä¸ªæ•°ï¼Œå¯ä»¥ä½¿ç”¨ `functools.partial()` ã€‚ `partial()` å‡½æ•°å…è®¸ç»™ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°è®¾ç½®å›ºå®šçš„å€¼ï¼Œå‡å°‘æ¥ä¸‹æ¥è¢«è°ƒç”¨æ—¶çš„å‚æ•°ä¸ªæ•°ã€‚ æœ‰ä¸‹é¢è¿™æ ·çš„å‡½æ•°ï¼š
```python
def spam(a, b, c, d):
    print(a, b, c, d)
```
ä½¿ç”¨ partial() å‡½æ•°æ¥å›ºå®šæŸäº›å‚æ•°å€¼ï¼š
```python
>>> from functools import partial
>>> s1 = partial(spam, 1) # a = 1
>>> s1(2, 3, 4)
1 2 3 4
>>> s1(4, 5, 6)
1 4 5 6
>>> s2 = partial(spam, d=42) # d = 42
>>> s2(1, 2, 3)
1 2 3 42
>>> s2(4, 5, 5)
4 5 5 42
>>> s3 = partial(spam, 1, 2, d=42) # a = 1, b = 2, d = 42
>>> s3(3)
1 2 3 42
>>> s3(4)
1 2 4 42
>>> s3(5)
1 2 5 42
>>>
```
å¯ä»¥çœ‹å‡º `partial()`å›ºå®šæŸäº›å‚æ•°å¹¶è¿”å›ä¸€ä¸ªæ–°çš„callableå¯¹è±¡ã€‚è¿™ä¸ªæ–°çš„callableæ¥å—æœªèµ‹å€¼çš„å‚æ•°ï¼Œ ç„¶åè·Ÿä¹‹å‰å·²ç»èµ‹å€¼è¿‡çš„å‚æ•°åˆå¹¶èµ·æ¥ï¼Œæœ€åå°†æ‰€æœ‰å‚æ•°ä¼ é€’ç»™åŸå§‹å‡½æ•°ã€‚



#### ğŸ¯ å°†å•æ–¹æ³•çš„ç±»è½¬æ¢ä¸ºå‡½æ•°ï¼ˆé—­åŒ…ï¼‰

ğŸ§  é—­åŒ…çš„å®šä¹‰

> **é—­åŒ…æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒâ€œè®°ä½äº†â€å®ƒè¢«åˆ›å»ºæ—¶çš„ä½œç”¨åŸŸï¼Œå³ä½¿å¤–å±‚å‡½æ•°å·²ç»ç»“æŸã€‚**

ä¹Ÿå°±æ˜¯è¯´ï¼š**å†…éƒ¨å‡½æ•°å¯ä»¥è®¿é—®å¤–éƒ¨å‡½æ•°çš„å˜é‡ï¼Œå³ä½¿å¤–éƒ¨å‡½æ•°å·²ç»è¿”å›ï¼**



âœ… å½¢æˆé—­åŒ…çš„ä¸‰ä¸ªå¿…è¦æ¡ä»¶ï¼š

1. æœ‰ä¸€ä¸ª**åµŒå¥—å‡½æ•°**ï¼ˆå‡½æ•°ä¸­å®šä¹‰å‡½æ•°ï¼‰
2. å¤–å±‚å‡½æ•°è¿”å›å†…å±‚å‡½æ•°
3. å†…å±‚å‡½æ•°å¼•ç”¨äº†å¤–å±‚å‡½æ•°çš„å˜é‡



ğŸŒ°ï¼šæœ‰ä¸€ä¸ªé™¤ `__init__()` æ–¹æ³•å¤–åªå®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•çš„ç±»ã€‚ä¸ºäº†ç®€åŒ–ä»£ç ï¼Œå°†å®ƒè½¬æ¢æˆä¸€ä¸ªå‡½æ•°ã€‚

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨é—­åŒ…æ¥å°†å•ä¸ªæ–¹æ³•çš„ç±»è½¬æ¢æˆå‡½æ•°ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹é¢ç¤ºä¾‹ä¸­çš„ç±»å…è®¸ä½¿ç”¨è€…æ ¹æ®æŸä¸ªæ¨¡æ¿æ–¹æ¡ˆæ¥è·å–åˆ°URLé“¾æ¥åœ°å€ã€‚

```python
from urllib.request import urlopen

class UrlTemplate:
    def __init__(self, template):
        self.template = template

    def open(self, **kwargs):
        return urlopen(self.template.format_map(kwargs))

# Example use. Download stock data from yahoo
yahoo = UrlTemplate('http://finance.yahoo.com/d/quotes.csv?s={names}&f={fields}')
for line in yahoo.open(names='IBM,AAPL,FB', fields='sl1c1v'):
    print(line.decode('utf-8'))
```

è¿™ä¸ªç±»å¯ä»¥è¢«ä¸€ä¸ªæ›´ç®€å•çš„å‡½æ•°æ¥ä»£æ›¿ï¼š
```python
def urltemplate(template):
    def opener(**kwargs):
        return urlopen(template.format_map(kwargs))
    return opener

# Example use
yahoo = urltemplate('http://finance.yahoo.com/d/quotes.csv?s={names}&f={fields}')
for line in yahoo(names='IBM,AAPL,FB', fields='sl1c1v'):
    print(line.decode('utf-8'))
```

å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæ‹¥æœ‰ä¸€ä¸ªå•æ–¹æ³•ç±»çš„åŸå› æ˜¯éœ€è¦å­˜å‚¨æŸäº›é¢å¤–çš„çŠ¶æ€æ¥ç»™æ–¹æ³•ä½¿ç”¨ã€‚ æ¯”å¦‚ï¼Œå®šä¹‰UrlTemplateç±»çš„å”¯ä¸€ç›®çš„å°±æ˜¯å…ˆåœ¨æŸä¸ªåœ°æ–¹å­˜å‚¨æ¨¡æ¿å€¼ï¼Œä»¥ä¾¿å°†æ¥å¯ä»¥åœ¨`open()`æ–¹æ³•ä¸­ä½¿ç”¨ã€‚

ä½¿ç”¨ä¸€ä¸ªå†…éƒ¨å‡½æ•°æˆ–è€…é—­åŒ…çš„æ–¹æ¡ˆé€šå¸¸ä¼šæ›´ä¼˜é›…ä¸€äº›ã€‚ç®€å•æ¥è®²ï¼Œä¸€ä¸ªé—­åŒ…å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œ åªä¸è¿‡åœ¨å‡½æ•°å†…éƒ¨å¸¦ä¸Šäº†ä¸€ä¸ªé¢å¤–çš„å˜é‡ç¯å¢ƒã€‚é—­åŒ…å…³é”®ç‰¹ç‚¹å°±æ˜¯å®ƒä¼šè®°ä½è‡ªå·±è¢«å®šä¹‰æ—¶çš„ç¯å¢ƒã€‚ å› æ­¤ï¼Œåœ¨æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆä¸­ï¼Œ`opener()` å‡½æ•°è®°ä½äº† `template` å‚æ•°çš„å€¼ï¼Œå¹¶åœ¨æ¥ä¸‹æ¥çš„è°ƒç”¨ä¸­ä½¿ç”¨å®ƒã€‚

ä»»ä½•æ—¶å€™åªè¦ç¢°åˆ°éœ€è¦ç»™æŸä¸ªå‡½æ•°å¢åŠ é¢å¤–çš„çŠ¶æ€ä¿¡æ¯çš„é—®é¢˜ï¼Œéƒ½å¯ä»¥è€ƒè™‘ä½¿ç”¨é—­åŒ…ã€‚ ç›¸æ¯”å°†çš„å‡½æ•°è½¬æ¢æˆä¸€ä¸ªç±»è€Œè¨€ï¼Œé—­åŒ…é€šå¸¸æ˜¯ä¸€ç§æ›´åŠ ç®€æ´å’Œä¼˜é›…çš„æ–¹æ¡ˆã€‚


#### ğŸ¯ å¸¦é¢å¤–çŠ¶æ€ä¿¡æ¯çš„å›è°ƒå‡½æ•°

ä»£ç ä¸­éœ€è¦ä¾èµ–åˆ°å›è°ƒå‡½æ•°çš„ä½¿ç”¨(æ¯”å¦‚äº‹ä»¶å¤„ç†å™¨ã€ç­‰å¾…åå°ä»»åŠ¡å®Œæˆåçš„å›è°ƒç­‰)ï¼Œ å¹¶ä¸”è¿˜éœ€è¦è®©å›è°ƒå‡½æ•°æ‹¥æœ‰é¢å¤–çš„çŠ¶æ€å€¼ï¼Œä»¥ä¾¿åœ¨å®ƒçš„å†…éƒ¨ä½¿ç”¨åˆ°ã€‚

è¿™é‡Œä¸»è¦è®¨è®ºçš„æ˜¯é‚£äº›å‡ºç°åœ¨å¾ˆå¤šå‡½æ•°åº“å’Œæ¡†æ¶ä¸­çš„å›è°ƒå‡½æ•°çš„ä½¿ç”¨â€”â€”ç‰¹åˆ«æ˜¯è·Ÿå¼‚æ­¥å¤„ç†æœ‰å…³çš„ã€‚ ä¸ºäº†æ¼”ç¤ºä¸æµ‹è¯•ï¼Œå…ˆå®šä¹‰å¦‚ä¸‹ä¸€ä¸ªéœ€è¦è°ƒç”¨å›è°ƒå‡½æ•°çš„å‡½æ•°ï¼š

```python
def apply_async(func, args, *, callback):
    # Compute the result
    result = func(*args)

    # Invoke the callback with the result
    callback(result)


>>> def print_result(result):
...     print('Got:', result)
...
>>> def add(x, y):
...     return x + y
...
>>> apply_async(add, (2, 3), callback=print_result)
Got: 5
>>> apply_async(add, ('hello', 'world'), callback=print_result)
Got: helloworld
>>>
```

æ³¨æ„åˆ° `print_result()` å‡½æ•°ä»…ä»…åªæ¥å—ä¸€ä¸ªå‚æ•° `result` ã€‚ä¸èƒ½å†ä¼ å…¥å…¶ä»–ä¿¡æ¯ã€‚ è€Œå½“æƒ³è®©å›è°ƒå‡½æ•°è®¿é—®å…¶ä»–å˜é‡æˆ–è€…ç‰¹å®šç¯å¢ƒçš„å˜é‡å€¼çš„æ—¶å€™å°±ä¼šé‡åˆ°éº»çƒ¦ã€‚

ä¸ºäº†è®©å›è°ƒå‡½æ•°è®¿é—®å¤–éƒ¨ä¿¡æ¯ï¼Œä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ªç»‘å®šæ–¹æ³•æ¥ä»£æ›¿ä¸€ä¸ªç®€å•å‡½æ•°ã€‚ æ¯”å¦‚ï¼Œä¸‹é¢è¿™ä¸ªç±»ä¼šä¿å­˜ä¸€ä¸ªå†…éƒ¨åºåˆ—å·ï¼Œæ¯æ¬¡æ¥æ”¶åˆ°ä¸€ä¸ª `result` çš„æ—¶å€™åºåˆ—å·åŠ 1ï¼š

```python
class ResultHandler:

    def __init__(self):
        self.sequence = 0

    def handler(self, result):
        self.sequence += 1
        print('[{}] Got: {}'.format(self.sequence, result))

>>> r = ResultHandler()
>>> apply_async(add, (2, 3), callback=r.handler)
[1] Got: 5
>>> apply_async(add, ('hello', 'world'), callback=r.handler)
[2] Got: helloworld
>>>
```

ç¬¬äºŒç§æ–¹å¼ï¼Œä½œä¸ºç±»çš„æ›¿ä»£ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªé—­åŒ…æ•è·çŠ¶æ€å€¼ï¼Œä¾‹å¦‚ï¼š

å¦‚æœä½¿ç”¨é—­åŒ…ï¼Œéœ€è¦æ³¨æ„å¯¹é‚£äº›å¯ä¿®æ”¹å˜é‡çš„æ“ä½œã€‚åœ¨ä¸‹é¢çš„æ–¹æ¡ˆä¸­ï¼Œ nonlocal å£°æ˜è¯­å¥ç”¨æ¥æŒ‡ç¤ºæ¥ä¸‹æ¥çš„å˜é‡ä¼šåœ¨å›è°ƒå‡½æ•°ä¸­è¢«ä¿®æ”¹ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªå£°æ˜ï¼Œä»£ç ä¼šæŠ¥é”™ã€‚
```python
def make_handler():
    sequence = 0
    def handler(result):
        nonlocal sequence
        sequence += 1
        print('[{}] Got: {}'.format(sequence, result))
    return handler


>>> handler = make_handler()
>>> apply_async(add, (2, 3), callback=handler)
[1] Got: 5
>>> apply_async(add, ('hello', 'world'), callback=handler)
[2] Got: helloworld
>>>
```

è¿˜æœ‰å¦å¤–ä¸€ä¸ªæ›´é«˜çº§çš„æ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨åç¨‹æ¥å®ŒæˆåŒæ ·çš„äº‹æƒ…ï¼š
```python
def make_handler():
    sequence = 0
    while True:
        result = yield
        sequence += 1
        print('[{}] Got: {}'.format(sequence, result))


>>> handler = make_handler()
>>> next(handler) # Advance to the yield
>>> apply_async(add, (2, 3), callback=handler.send)
[1] Got: 5
>>> apply_async(add, ('hello', 'world'), callback=handler.send)
[2] Got: helloworld
>>>
```

åŸºäºå›è°ƒå‡½æ•°çš„è½¯ä»¶é€šå¸¸éƒ½æœ‰å¯èƒ½å˜å¾—éå¸¸å¤æ‚ã€‚ä¸€éƒ¨åˆ†åŸå› æ˜¯å›è°ƒå‡½æ•°é€šå¸¸ä¼šè·Ÿè¯·æ±‚æ‰§è¡Œä»£ç æ–­å¼€ã€‚ å› æ­¤ï¼Œè¯·æ±‚æ‰§è¡Œå’Œå¤„ç†ç»“æœä¹‹é—´çš„æ‰§è¡Œç¯å¢ƒå®é™…ä¸Šå·²ç»ä¸¢å¤±äº†ã€‚å¦‚æœæƒ³è®©å›è°ƒå‡½æ•°è¿ç»­æ‰§è¡Œå¤šæ­¥æ“ä½œï¼Œ é‚£å°±å¿…é¡»å»è§£å†³å¦‚ä½•ä¿å­˜å’Œæ¢å¤ç›¸å…³çš„çŠ¶æ€ä¿¡æ¯äº†ã€‚


#### ğŸ¯ å†…è”å›è°ƒå‡½æ•°

ç¼–å†™ä½¿ç”¨å›è°ƒå‡½æ•°çš„ä»£ç çš„æ—¶å€™ï¼Œæ‹…å¿ƒå¾ˆå¤šå°å‡½æ•°çš„æ‰©å¼ å¯èƒ½ä¼šå¼„ä¹±ç¨‹åºæ§åˆ¶æµã€‚å¸Œæœ›æ‰¾åˆ°æŸä¸ªæ–¹æ³•æ¥è®©ä»£ç çœ‹ä¸Šå»æ›´åƒæ˜¯ä¸€ä¸ªæ™®é€šçš„æ‰§è¡Œåºåˆ—ã€‚

é€šè¿‡ä½¿ç”¨ç”Ÿæˆå™¨å’Œåç¨‹å¯ä»¥ä½¿å¾—å›è°ƒå‡½æ•°å†…è”åœ¨æŸä¸ªå‡½æ•°ä¸­ã€‚
```python
def apply_async(func, args, *, callback):
    # Compute the result
    result = func(*args)

    # Invoke the callback with the result
    callback(result)

from queue import Queue
from functools import wraps

class Async:
    def __init__(self, func, args):
        self.func = func
        self.args = args

def inlined_async(func):
    @wraps(func)
    def wrapper(*args):
        f = func(*args)
        result_queue = Queue()
        result_queue.put(None)
        while True:
            result = result_queue.get()
            try:
                a = f.send(result)
                apply_async(a.func, a.args, callback=result_queue.put)
            except StopIteration:
                break
    return wrapper

def add(x, y):
    return x + y

@inlined_async
def test():
    r = yield Async(add, (2, 3))
    print(r)
    r = yield Async(add, ('hello', 'world'))
    print(r)
    for n in range(10):
        r = yield Async(add, (n, n))
        print(r)
    print('Goodbye')
```
å‘ç°é™¤äº†é‚£ä¸ªç‰¹åˆ«çš„è£…é¥°å™¨å’Œ `yield` è¯­å¥å¤–ï¼Œå…¶ä»–åœ°æ–¹å¹¶æ²¡æœ‰å‡ºç°ä»»ä½•çš„å›è°ƒå‡½æ•°(å…¶å®æ˜¯åœ¨åå°å®šä¹‰çš„)ã€‚

å°†å¤æ‚çš„æ§åˆ¶æµéšè—åˆ°ç”Ÿæˆå™¨å‡½æ•°èƒŒåçš„ä¾‹å­åœ¨æ ‡å‡†åº“å’Œç¬¬ä¸‰æ–¹åŒ…ä¸­éƒ½èƒ½çœ‹åˆ°ã€‚ æ¯”å¦‚ï¼Œåœ¨ `contextlib` ä¸­çš„ `@contextmanager` è£…é¥°å™¨ä½¿ç”¨äº†ä¸€ä¸ªä»¤äººè´¹è§£çš„æŠ€å·§ï¼Œ é€šè¿‡ä¸€ä¸ª `yield` è¯­å¥å°†è¿›å…¥å’Œç¦»å¼€ä¸Šä¸‹æ–‡ç®¡ç†å™¨ç²˜åˆåœ¨ä¸€èµ·ã€‚ å¦å¤–éå¸¸æµè¡Œçš„ `Twisted` åŒ…ä¸­ä¹ŸåŒ…å«äº†éå¸¸ç±»ä¼¼çš„å†…è”å›è°ƒã€‚



#### ğŸ¯ è®¿é—®é—­åŒ…ä¸­å®šä¹‰çš„å˜é‡

æƒ³è¦æ‰©å±•å‡½æ•°ä¸­çš„æŸä¸ªé—­åŒ…ï¼Œå…è®¸å®ƒèƒ½è®¿é—®å’Œä¿®æ”¹å‡½æ•°çš„å†…éƒ¨å˜é‡ã€‚

é€šå¸¸æ¥è®²ï¼Œé—­åŒ…çš„å†…éƒ¨å˜é‡å¯¹äºå¤–ç•Œæ¥è®²æ˜¯å®Œå…¨éšè—çš„ã€‚ ä½†æ˜¯ï¼Œå¯ä»¥é€šè¿‡ç¼–å†™è®¿é—®å‡½æ•°å¹¶å°†å…¶ä½œä¸ºå‡½æ•°å±æ€§ç»‘å®šåˆ°é—­åŒ…ä¸Šæ¥å®ç°è¿™ä¸ªç›®çš„ã€‚ä¾‹å¦‚ï¼š
```python
def sample():
    n = 0
    # Closure function
    def func():
        print('n=', n)

    # Accessor methods for n
    def get_n():
        return n

    def set_n(value):
        nonlocal n
        n = value

    # Attach as function attributes
    func.get_n = get_n
    func.set_n = set_n
    return func
```
ä¸‹é¢æ˜¯ä½¿ç”¨çš„ä¾‹å­:
```python
>>> f = sample()
>>> f()
n= 0
>>> f.set_n(10)
>>> f()
n= 10
>>> f.get_n()
10
>>>
```

é¦–å…ˆï¼Œnonlocal å£°æ˜å¯ä»¥è®©æˆ‘ä»¬ç¼–å†™å‡½æ•°æ¥ä¿®æ”¹å†…éƒ¨å˜é‡çš„å€¼ã€‚ å…¶æ¬¡ï¼Œå‡½æ•°å±æ€§å…è®¸æˆ‘ä»¬ç”¨ä¸€ç§å¾ˆç®€å•çš„æ–¹å¼å°†è®¿é—®æ–¹æ³•ç»‘å®šåˆ°é—­åŒ…å‡½æ•°ä¸Šï¼Œè¿™ä¸ªè·Ÿå®ä¾‹æ–¹æ³•å¾ˆåƒ(å°½ç®¡å¹¶æ²¡æœ‰å®šä¹‰ä»»ä½•ç±»)ã€‚

è¿˜å¯ä»¥è¿›ä¸€æ­¥çš„æ‰©å±•ï¼Œè®©é—­åŒ…æ¨¡æ‹Ÿç±»çš„å®ä¾‹ã€‚



### ğŸ ç±»ä¸å¯¹è±¡

#### ğŸ¯ å°è£…ã€ç»§æ‰¿ã€å¤šæ€

- **å°è£… (Encapsulation):** è¿™æŒ‡çš„æ˜¯å°†æ•°æ®ï¼ˆå±æ€§ï¼‰å’Œæ“ä½œæ•°æ®çš„æ–¹æ³•æ†ç»‘åˆ°ä¸€ä¸ªå•å…ƒï¼ˆå³ä¸€ä¸ªç±»ï¼‰ä¸­ã€‚åœ¨ Python ä¸­ï¼Œå¯ä»¥é€šè¿‡å°†å±æ€§å£°æ˜ä¸ºç§æœ‰ï¼ˆä»¥ä¸¤ä¸ªä¸‹åˆ’çº¿å¼€å¤´ï¼‰æ¥éšè—å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œåªå…è®¸é€šè¿‡å¯¹è±¡çš„æ–¹æ³•è¿›è¡Œè®¿é—®å’Œä¿®æ”¹ã€‚è¿™æœ‰åŠ©äºä¿æŠ¤æ•°æ®ä¸è¢«æ„å¤–æ›´æ”¹ã€‚

  

- **ç»§æ‰¿ (Inheritance):** ç»§æ‰¿æ˜¯ä¸€ç§æœºåˆ¶ï¼Œä¸€ä¸ªç±»ï¼ˆç§°ä¸ºå­ç±»æˆ–æ´¾ç”Ÿç±»ï¼‰å¯ä»¥ç»§æ‰¿å¦ä¸€ä¸ªç±»ï¼ˆç§°ä¸ºçˆ¶ç±»æˆ–åŸºç±»ï¼‰çš„å±æ€§å’Œæ–¹æ³•ã€‚è¿™ä½¿å¾—å­ç±»å¯ä»¥é‡ç”¨çˆ¶ç±»çš„ä»£ç ï¼Œå¹¶å¯ä»¥æ·»åŠ è‡ªå·±ç‹¬ç‰¹çš„åŠŸèƒ½æˆ–è¦†ç›–çˆ¶ç±»çš„æ–¹æ³•ä»¥æ»¡è¶³ç‰¹å®šéœ€æ±‚ã€‚

  

- **å¤šæ€ (Polymorphism):** å¤šæ€æ„å‘³ç€ä¸åŒç±»çš„å¯¹è±¡å¯ä»¥å¯¹ç›¸åŒçš„æ–¹æ³•ååšå‡ºä¸åŒçš„å“åº”ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å…è®¸æˆ‘ä»¬ä»¥åŒæ ·çš„æ–¹å¼å¤„ç†ä¸åŒç±»å‹çš„å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå‡½æ•°å¯ä»¥æ¥å—ä»»ä½•å…·æœ‰ç‰¹å®šæ–¹æ³•ï¼ˆå¦‚ `fly()`ï¼‰çš„å¯¹è±¡ï¼Œè€Œä¸ç®¡è¿™ä¸ªå¯¹è±¡æ˜¯é¸Ÿè¿˜æ˜¯é£æœºï¼Œè°ƒç”¨è¯¥æ–¹æ³•æ—¶ä¼šæ‰§è¡Œå„è‡ªç±»çš„å®ç°ã€‚

  

#### ğŸ¯ æ”¹å˜å¯¹è±¡çš„å­—ç¬¦ä¸²æ˜¾ç¤º

è¦æ”¹å˜ä¸€ä¸ªå®ä¾‹çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œå¯é‡æ–°å®šä¹‰å®ƒçš„ `__str__()` å’Œ `__repr__()` æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š
```python
class Pair:
    def __init__(self, x, y):
        self.x = x
        self.y = y

    def __repr__(self):
        return 'Pair({0.x!r}, {0.y!r})'.format(self)

    def __str__(self):
        return '({0.x!s}, {0.y!s})'.format(self)
```
`__repr__()` æ–¹æ³•è¿”å›ä¸€ä¸ªå®ä¾‹çš„ä»£ç è¡¨ç¤ºå½¢å¼ï¼Œé€šå¸¸ç”¨æ¥é‡æ–°æ„é€ è¿™ä¸ªå®ä¾‹ã€‚ å†…ç½®çš„ repr() å‡½æ•°è¿”å›è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œè·Ÿæˆ‘ä»¬ä½¿ç”¨äº¤äº’å¼è§£é‡Šå™¨æ˜¾ç¤ºçš„å€¼æ˜¯ä¸€æ ·çš„ã€‚` __str__()` æ–¹æ³•å°†å®ä¾‹è½¬æ¢ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½¿ç”¨ `str()` æˆ– `print()` å‡½æ•°ä¼šè¾“å‡ºè¿™ä¸ªå­—ç¬¦ä¸²ã€‚æ¯”å¦‚ï¼š

```python
>>> p = Pair(3, 4)
>>> p
Pair(3, 4) # __repr__() output
>>> print(p)
(3, 4) # __str__() output
>>>
```
æˆ‘ä»¬åœ¨è¿™é‡Œè¿˜æ¼”ç¤ºäº†åœ¨æ ¼å¼åŒ–çš„æ—¶å€™æ€æ ·ä½¿ç”¨ä¸åŒçš„å­—ç¬¦ä¸²è¡¨ç°å½¢å¼ã€‚ ç‰¹åˆ«æ¥è®²ï¼Œ`!r` æ ¼å¼åŒ–ä»£ç æŒ‡æ˜è¾“å‡ºä½¿ç”¨ `__repr__()` æ¥ä»£æ›¿é»˜è®¤çš„ `__str__()` ã€‚ å¯ä»¥ç”¨å‰é¢çš„ç±»æ¥è¯•ç€æµ‹è¯•ä¸‹ï¼š
```python
>>> p = Pair(3, 4)
>>> print('p is {0!r}'.format(p))
p is Pair(3, 4)
>>> print('p is {0}'.format(p))
p is (3, 4)
>>>
```
ä¸Šé¢çš„ `format()` æ–¹æ³•çš„ä½¿ç”¨çœ‹ä¸Šå»å¾ˆæœ‰è¶£ï¼Œæ ¼å¼åŒ–ä»£ç  `{0.x}` å¯¹åº”çš„æ˜¯ç¬¬1ä¸ªå‚æ•°çš„xå±æ€§ã€‚ å› æ­¤ï¼Œåœ¨ä¸‹é¢çš„å‡½æ•°ä¸­ï¼Œ0å®é™…ä¸ŠæŒ‡çš„å°±æ˜¯ `self` æœ¬èº«ï¼š
```python
def __repr__(self):
    return 'Pair({0.x!r}, {0.y!r})'.format(self)
```
ä½œä¸ºè¿™ç§å®ç°çš„ä¸€ä¸ªæ›¿ä»£ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`%` æ“ä½œç¬¦ï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š
```python
def __repr__(self):
    return 'Pair(%r, %r)' % (self.x, self.y)
```


#### ğŸ¯ è‡ªå®šä¹‰å­—ç¬¦ä¸²çš„æ ¼å¼åŒ–

é€šè¿‡ `format()` å‡½æ•°å’Œå­—ç¬¦ä¸²æ–¹æ³•ä½¿å¾—ä¸€ä¸ªå¯¹è±¡èƒ½æ”¯æŒè‡ªå®šä¹‰çš„æ ¼å¼åŒ–ã€‚

ä¸ºäº†è‡ªå®šä¹‰å­—ç¬¦ä¸²çš„æ ¼å¼åŒ–ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç±»ä¸Šé¢å®šä¹‰ `__format__()` æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š
```python
_formats = {
    'ymd' : '{d.year}-{d.month}-{d.day}',
    'mdy' : '{d.month}/{d.day}/{d.year}',
    'dmy' : '{d.day}/{d.month}/{d.year}'
    }

class Date:
    def __init__(self, year, month, day):
        self.year = year
        self.month = month
        self.day = day

    def __format__(self, code):
        if code == '':
            code = 'ymd'
        fmt = _formats[code]
        return fmt.format(d=self)
```
ç°åœ¨ `Date` ç±»çš„å®ä¾‹å¯ä»¥æ”¯æŒæ ¼å¼åŒ–æ“ä½œäº†ï¼Œå¦‚åŒä¸‹é¢è¿™æ ·ï¼š
```python
>>> d = Date(2012, 12, 21)
>>> format(d)
'2012-12-21'
>>> format(d, 'mdy')
'12/21/2012'
>>> 'The date is {:ymd}'.format(d)
'The date is 2012-12-21'
>>> 'The date is {:mdy}'.format(d)
'The date is 12/21/2012'
>>>
```

#### ğŸ¯ è®©å¯¹è±¡æ”¯æŒä¸Šä¸‹æ–‡ç®¡ç†åè®®
ä¸ºäº†è®©ä¸€ä¸ªå¯¹è±¡å…¼å®¹ `with` è¯­å¥ï¼Œéœ€è¦å®ç° `__enter__()` å’Œ `__exit__()` æ–¹æ³•ã€‚ ä¾‹å¦‚ï¼Œè€ƒè™‘å¦‚ä¸‹çš„ä¸€ä¸ªç±»ï¼Œå®ƒèƒ½ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç½‘ç»œè¿æ¥ï¼š
```python
from socket import socket, AF_INET, SOCK_STREAM

class LazyConnection:
    def __init__(self, address, family=AF_INET, type=SOCK_STREAM):
        self.address = address
        self.family = family
        self.type = type
        self.sock = None

    def __enter__(self):
        if self.sock is not None:
            raise RuntimeError('Already connected')
        self.sock = socket(self.family, self.type)
        self.sock.connect(self.address)
        return self.sock

    def __exit__(self, exc_ty, exc_val, tb):
        self.sock.close()
        self.sock = None
```
è¿™ä¸ªç±»çš„å…³é”®ç‰¹ç‚¹åœ¨äºå®ƒè¡¨ç¤ºäº†ä¸€ä¸ªç½‘ç»œè¿æ¥ï¼Œä½†æ˜¯åˆå§‹åŒ–çš„æ—¶å€™å¹¶ä¸ä¼šåšä»»ä½•äº‹æƒ…(æ¯”å¦‚å®ƒå¹¶æ²¡æœ‰å»ºç«‹ä¸€ä¸ªè¿æ¥)ã€‚ è¿æ¥çš„å»ºç«‹å’Œå…³é—­æ˜¯ä½¿ç”¨ `with` è¯­å¥è‡ªåŠ¨å®Œæˆçš„ï¼Œä¾‹å¦‚ï¼š
```python
from functools import partial

conn = LazyConnection(('www.python.org', 80))
# Connection closed
with conn as s:
    # conn.__enter__() executes: connection open
    s.send(b'GET /index.html HTTP/1.0\r\n')
    s.send(b'Host: www.python.org\r\n')
    s.send(b'\r\n')
    resp = b''.join(iter(partial(s.recv, 8192), b''))
    # conn.__exit__() executes: connection closed
```

ç¼–å†™ä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„ä¸»è¦åŸç†æ˜¯çš„ä»£ç ä¼šæ”¾åˆ° `with` è¯­å¥å—ä¸­æ‰§è¡Œã€‚ å½“å‡ºç° `with` è¯­å¥çš„æ—¶å€™ï¼Œå¯¹è±¡çš„ `__enter__()` æ–¹æ³•è¢«è§¦å‘ï¼Œ å®ƒè¿”å›çš„å€¼(å¦‚æœæœ‰çš„è¯)ä¼šè¢«èµ‹å€¼ç»™ `as` å£°æ˜çš„å˜é‡ã€‚ç„¶åï¼Œ`with` è¯­å¥å—é‡Œé¢çš„ä»£ç å¼€å§‹æ‰§è¡Œã€‚ æœ€åï¼Œ`__exit__()` æ–¹æ³•è¢«è§¦å‘è¿›è¡Œæ¸…ç†å·¥ä½œã€‚

ä¸ç®¡ `with` ä»£ç å—ä¸­å‘ç”Ÿä»€ä¹ˆï¼Œä¸Šé¢çš„æ§åˆ¶æµéƒ½ä¼šæ‰§è¡Œå®Œï¼Œå°±ç®—ä»£ç å—ä¸­å‘ç”Ÿäº†å¼‚å¸¸ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚ äº‹å®ä¸Šï¼Œ`__exit__()` æ–¹æ³•çš„ä¸‰ä¸ªå‚æ•°åŒ…å«äº†å¼‚å¸¸ç±»å‹ã€å¼‚å¸¸å€¼å’Œè¿½æº¯ä¿¡æ¯(å¦‚æœæœ‰çš„è¯)ã€‚ `__exit__()` æ–¹æ³•èƒ½è‡ªå·±å†³å®šæ€æ ·åˆ©ç”¨è¿™ä¸ªå¼‚å¸¸ä¿¡æ¯ï¼Œæˆ–è€…å¿½ç•¥å®ƒå¹¶è¿”å›ä¸€ä¸ªNoneå€¼ã€‚ å¦‚æœ `__exit__()` è¿”å› `True` ï¼Œé‚£ä¹ˆå¼‚å¸¸ä¼šè¢«æ¸…ç©ºï¼Œå°±å¥½åƒä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿä¸€æ ·ï¼Œ `with` è¯­å¥åé¢çš„ç¨‹åºç»§ç»­åœ¨æ­£å¸¸æ‰§è¡Œã€‚


#### ğŸ¯ åˆ›å»ºå¤§é‡å¯¹è±¡æ—¶èŠ‚çœå†…å­˜æ–¹æ³•
å¯¹äºä¸»è¦æ˜¯ç”¨æ¥å½“æˆç®€å•çš„æ•°æ®ç»“æ„çš„ç±»è€Œè¨€ï¼Œå¯ä»¥é€šè¿‡ç»™ç±»æ·»åŠ  `__slots__` å±æ€§æ¥æå¤§çš„å‡å°‘å®ä¾‹æ‰€å çš„å†…å­˜ã€‚æ¯”å¦‚ï¼š
```python
class Date:
    __slots__ = ['year', 'month', 'day']
    def __init__(self, year, month, day):
        self.year = year
        self.month = month
        self.day = day
```
å½“å®šä¹‰ `__slots__` åï¼ŒPythonå°±ä¼šä¸ºå®ä¾‹ä½¿ç”¨ä¸€ç§æ›´åŠ ç´§å‡‘çš„å†…éƒ¨è¡¨ç¤ºã€‚ å®ä¾‹é€šè¿‡ä¸€ä¸ªå¾ˆå°çš„å›ºå®šå¤§å°çš„æ•°ç»„æ¥æ„å»ºï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªå®ä¾‹å®šä¹‰ä¸€ä¸ªå­—å…¸ï¼Œè¿™è·Ÿå…ƒç»„æˆ–åˆ—è¡¨å¾ˆç±»ä¼¼ã€‚ åœ¨ `__slots__` ä¸­åˆ—å‡ºçš„å±æ€§ååœ¨å†…éƒ¨è¢«æ˜ å°„åˆ°è¿™ä¸ªæ•°ç»„çš„æŒ‡å®šå°æ ‡ä¸Šã€‚ ä½¿ç”¨slotsä¸€ä¸ªä¸å¥½çš„åœ°æ–¹å°±æ˜¯æˆ‘ä»¬ä¸èƒ½å†ç»™å®ä¾‹æ·»åŠ æ–°çš„å±æ€§äº†ï¼Œåªèƒ½ä½¿ç”¨åœ¨ `__slots__` ä¸­å®šä¹‰çš„é‚£äº›å±æ€§åã€‚

å…³äº `__slots__` çš„ä¸€ä¸ªå¸¸è§è¯¯åŒºæ˜¯å®ƒå¯ä»¥ä½œä¸ºä¸€ä¸ªå°è£…å·¥å…·æ¥é˜²æ­¢ç”¨æˆ·ç»™å®ä¾‹å¢åŠ æ–°çš„å±æ€§ã€‚ å°½ç®¡ä½¿ç”¨slotså¯ä»¥è¾¾åˆ°è¿™æ ·çš„ç›®çš„ï¼Œä½†æ˜¯è¿™ä¸ªå¹¶ä¸æ˜¯å®ƒçš„åˆè¡·ã€‚ `__slots__` æ›´å¤šçš„æ˜¯ç”¨æ¥ä½œä¸ºä¸€ä¸ªå†…å­˜ä¼˜åŒ–å·¥å…·ã€‚


#### ğŸ¯ åœ¨ç±»ä¸­å°è£…å±æ€§å
Pythonä¸å»ä¾èµ–è¯­è¨€ç‰¹æ€§å»å°è£…æ•°æ®ï¼Œè€Œæ˜¯é€šè¿‡éµå¾ªä¸€å®šçš„å±æ€§å’Œæ–¹æ³•å‘½åè§„çº¦æ¥è¾¾åˆ°è¿™ä¸ªæ•ˆæœã€‚ ç¬¬ä¸€ä¸ªçº¦å®šæ˜¯ä»»ä½•ä»¥å•ä¸‹åˆ’çº¿`_`å¼€å¤´çš„åå­—éƒ½åº”è¯¥æ˜¯å†…éƒ¨å®ç°ã€‚æ¯”å¦‚ï¼š
```python
class A:
    def __init__(self):
        self._internal = 0 # An internal attribute
        self.public = 1 # A public attribute

    def public_method(self):
        '''A public method
        '''
        pass

    def _internal_method(self):
        pass
```
Pythonå¹¶ä¸ä¼šçœŸçš„é˜»æ­¢åˆ«äººè®¿é—®å†…éƒ¨åç§°ã€‚ä½†æ˜¯å¦‚æœè¿™ä¹ˆåšè‚¯å®šæ˜¯ä¸å¥½çš„ï¼Œå¯èƒ½ä¼šå¯¼è‡´è„†å¼±çš„ä»£ç ã€‚ åŒæ—¶è¿˜è¦æ³¨æ„åˆ°ï¼Œä½¿ç”¨ä¸‹åˆ’çº¿å¼€å¤´çš„çº¦å®šåŒæ ·é€‚ç”¨äºæ¨¡å—åå’Œæ¨¡å—çº§åˆ«å‡½æ•°ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœçœ‹åˆ°æŸä¸ªæ¨¡å—åä»¥å•ä¸‹åˆ’çº¿å¼€å¤´(æ¯”å¦‚_socket)ï¼Œé‚£å®ƒå°±æ˜¯å†…éƒ¨å®ç°ã€‚ç±»ä¼¼çš„ï¼Œæ¨¡å—çº§åˆ«å‡½æ•°æ¯”å¦‚ `sys._getframe()` åœ¨ä½¿ç”¨çš„æ—¶å€™å°±å¾—åŠ å€å°å¿ƒäº†ã€‚

è¿˜å¯èƒ½ä¼šé‡åˆ°åœ¨ç±»å®šä¹‰ä¸­ä½¿ç”¨ä¸¤ä¸ªä¸‹åˆ’çº¿(__)å¼€å¤´çš„å‘½åã€‚æ¯”å¦‚ï¼š
```python
class B:
    def __init__(self):
        self.__private = 0

    def __private_method(self):
        pass

    def public_method(self):
        pass
        self.__private_method()
```
ä½¿ç”¨åŒä¸‹åˆ’çº¿å¼€å§‹ä¼šå¯¼è‡´è®¿é—®åç§°å˜æˆå…¶ä»–å½¢å¼ã€‚ æ¯”å¦‚ï¼Œåœ¨å‰é¢çš„ç±»Bä¸­ï¼Œç§æœ‰å±æ€§ä¼šè¢«åˆ†åˆ«é‡å‘½åä¸º `_B__private` å’Œ `_B__private_method`ã€‚

è¿™æ—¶å€™å¯èƒ½ä¼šé—®è¿™æ ·é‡å‘½åçš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Œç­”æ¡ˆå°±æ˜¯ç»§æ‰¿â€”â€”è¿™ç§å±æ€§é€šè¿‡ç»§æ‰¿æ˜¯æ— æ³•è¢«è¦†ç›–çš„ã€‚æ¯”å¦‚ï¼š
```python
class C(B):
    def __init__(self):
        super().__init__()
        self.__private = 1 # Does not override B.__private

    # Does not override B.__private_method()
    def __private_method(self):
        pass
```
è¿™é‡Œï¼Œç§æœ‰åç§° `__private` å’Œ `__private_method` è¢«é‡å‘½åä¸º `_C__private` å’Œ `_C__private_method` ï¼Œè¿™ä¸ªè·Ÿçˆ¶ç±»Bä¸­çš„åç§°æ˜¯å®Œå…¨ä¸åŒçš„ã€‚


#### ğŸ¯ åˆ›å»ºå¯ç®¡ç†çš„å±æ€§
æƒ³ç»™æŸä¸ªå®ä¾‹ attribute å¢åŠ é™¤è®¿é—®ä¸ä¿®æ”¹ä¹‹å¤–çš„å…¶ä»–å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚ç±»å‹æ£€æŸ¥æˆ–åˆæ³•æ€§éªŒè¯ã€‚

è‡ªå®šä¹‰æŸä¸ªå±æ€§çš„ä¸€ç§ç®€å•æ–¹æ³•æ˜¯å°†å®ƒå®šä¹‰ä¸ºä¸€ä¸ª propertyã€‚ 

âš ï¸æ³¨æ„ï¼šä¸€ä¸ª property å…¶å®æ˜¯ `getter`ã€`setter` å’Œ `deleter` æ–¹æ³•çš„é›†åˆï¼Œè€Œä¸æ˜¯å•ä¸ªæ–¹æ³•ã€‚
```python
class Person:
    def __init__(self, first_name):
        self._first_name = first_name

    # Getter function
    @property
    def first_name(self):
        return self._first_name

    # Setter function
    @first_name.setter
    def first_name(self, value):
        if not isinstance(value, str):
            raise TypeError('Expected a string')
        self._first_name = value

    # Deleter function (optional)
    @first_name.deleter
    def first_name(self):
        raise AttributeError("Can't delete attribute")
```

ä¸Šè¿°ä»£ç ä¸­æœ‰ä¸‰ä¸ªç›¸å…³è”çš„æ–¹æ³•ï¼Œè¿™ä¸‰ä¸ªæ–¹æ³•çš„åå­—éƒ½å¿…é¡»ä¸€æ ·ã€‚ ç¬¬ä¸€ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ª `getter` å‡½æ•°ï¼Œå®ƒä½¿å¾— `first_name` æˆä¸ºä¸€ä¸ªå±æ€§ã€‚ å…¶ä»–ä¸¤ä¸ªæ–¹æ³•ç»™ `first_name` å±æ€§æ·»åŠ äº† `setter` å’Œ `deleter` å‡½æ•°ã€‚ éœ€è¦å¼ºè°ƒçš„æ˜¯åªæœ‰åœ¨ `first_name` å±æ€§è¢«åˆ›å»ºåï¼Œ åé¢çš„ä¸¤ä¸ªè£…é¥°å™¨ `@first_name.setter` å’Œ `@first_name.deleter` æ‰èƒ½è¢«å®šä¹‰ã€‚

propertyçš„ä¸€ä¸ªå…³é”®ç‰¹å¾æ˜¯å®ƒçœ‹ä¸Šå»è·Ÿæ™®é€šçš„attributeæ²¡ä»€ä¹ˆä¸¤æ ·ï¼Œ ä½†æ˜¯è®¿é—®å®ƒçš„æ—¶å€™ä¼šè‡ªåŠ¨è§¦å‘ `getter` ã€`setter` å’Œ `deleter` æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š
```python
>>> a = Person('Guido')
>>> a.first_name # Calls the getter
'Guido'
>>> a.first_name = 42 # Calls the setter
Traceback (most recent call last):
    File "<stdin>", line 1, in <module>
    File "prop.py", line 14, in first_name
        raise TypeError('Expected a string')
TypeError: Expected a string
>>> del a.first_name
Traceback (most recent call last):
    File "<stdin>", line 1, in <module>
AttributeError: can`t delete attribute
>>>
```
åªæœ‰å½“ç¡®å®éœ€è¦å¯¹ attribute æ‰§è¡Œå…¶ä»–é¢å¤–çš„æ“ä½œçš„æ—¶å€™æ‰åº”è¯¥ä½¿ç”¨åˆ° propertyï¼Œä¸è¦å†™æ²¡æœ‰åšä»»ä½•å…¶ä»–é¢å¤–æ“ä½œçš„propertyã€‚

ä¸è¦åƒä¸‹é¢è¿™æ ·å†™æœ‰å¤§é‡é‡å¤ä»£ç çš„ property å®šä¹‰ï¼š
```python
class Person:
    def __init__(self, first_name, last_name):
        self.first_name = first_name
        self.last_name = last_name

    @property
    def first_name(self):
        return self._first_name

    @first_name.setter
    def first_name(self, value):
        if not isinstance(value, str):
            raise TypeError('Expected a string')
        self._first_name = value

    # Repeated property code, but for a different name (bad!)
    @property
    def last_name(self):
        return self._last_name

    @last_name.setter
    def last_name(self, value):
        if not isinstance(value, str):
            raise TypeError('Expected a string')
        self._last_name = value
```
é‡å¤ä»£ç ä¼šå¯¼è‡´è‡ƒè‚¿ã€æ˜“å‡ºé”™å’Œä¸‘é™‹çš„ç¨‹åºã€‚å¥½æ¶ˆæ¯æ˜¯ï¼Œé€šè¿‡ä½¿ç”¨è£…é¥°å™¨æˆ–é—­åŒ…ï¼Œæœ‰å¾ˆå¤šç§æ›´å¥½çš„æ–¹æ³•æ¥å®ŒæˆåŒæ ·çš„äº‹æƒ…ã€‚


#### ğŸ¯ è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼ˆMROåˆ—è¡¨ï¼‰
ä¸ºäº†è°ƒç”¨çˆ¶ç±»(è¶…ç±»)çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨ `super()` å‡½æ•°ï¼Œæ¯”å¦‚ï¼š
```python
class A:
    def spam(self):
        print('A.spam')

class B(A):
    def spam(self):
        print('B.spam')
        super().spam()  # Call parent spam()
```
`super()` å‡½æ•°çš„ä¸€ä¸ªå¸¸è§ç”¨æ³•æ˜¯åœ¨ `__init__()` æ–¹æ³•ä¸­ç¡®ä¿çˆ¶ç±»è¢«æ­£ç¡®çš„åˆå§‹åŒ–äº†ï¼š
```python
class A:
    def __init__(self):
        self.x = 0

class B(A):
    def __init__(self):
        super().__init__()
        self.y = 1
```

å¤šç»§æ‰¿ æ–¹æ³•è§£æé¡ºåº(MRO)åˆ—è¡¨ï¼ˆC3ç®—æ³•ï¼‰
```python
# class Base:
#     def __init__(self):
#         print('Base.__init__')

# class A(Base):
#     def __init__(self):
#         Base.__init__(self)
#         print('A.__init__')

# class B(Base):
#     def __init__(self):
#         Base.__init__(self)
#         print('B.__init__')

# class C(A,B):
#     def __init__(self):
#         A.__init__(self)
#         B.__init__(self)
#         print('C.__init__')


class Base:
    def __init__(self):
        print('Base.__init__')

class A(Base):
    def __init__(self):
        super().__init__()
        print('A.__init__')

class B(Base):
    def __init__(self):
        super().__init__()
        print('B.__init__')

class C(A,B):
    def __init__(self):
        super().__init__()  # Only one call to super() here
        print('C.__init__')
```
å¯¹äºå®šä¹‰çš„æ¯ä¸€ä¸ªç±»ï¼ŒPythonä¼šè®¡ç®—å‡ºä¸€ä¸ªæ‰€è°“çš„æ–¹æ³•è§£æé¡ºåº(MRO)åˆ—è¡¨ã€‚ è¿™ä¸ªMROåˆ—è¡¨å°±æ˜¯ä¸€ä¸ªç®€å•çš„æ‰€æœ‰åŸºç±»çš„çº¿æ€§é¡ºåºè¡¨ã€‚ä¾‹å¦‚ï¼š
```python
>>> C.__mro__
(<class '__main__.C'>, <class '__main__.A'>, <class '__main__.B'>,
<class '__main__.Base'>, <class 'object'>)
>>>
```
ä¸ºäº†å®ç°ç»§æ‰¿ï¼ŒPythonä¼šåœ¨MROåˆ—è¡¨ä¸Šä»å·¦åˆ°å³å¼€å§‹æŸ¥æ‰¾åŸºç±»ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…è¿™ä¸ªå±æ€§çš„ç±»ä¸ºæ­¢ã€‚

è€Œè¿™ä¸ªMROåˆ—è¡¨çš„æ„é€ æ˜¯é€šè¿‡ä¸€ä¸ªC3çº¿æ€§åŒ–ç®—æ³•æ¥å®ç°çš„ã€‚ æˆ‘ä»¬ä¸å»æ·±ç©¶è¿™ä¸ªç®—æ³•çš„æ•°å­¦åŸç†ï¼Œå®ƒå®é™…ä¸Šå°±æ˜¯åˆå¹¶æ‰€æœ‰çˆ¶ç±»çš„MROåˆ—è¡¨å¹¶éµå¾ªå¦‚ä¸‹ä¸‰æ¡å‡†åˆ™ï¼š

- å­ç±»ä¼šå…ˆäºçˆ¶ç±»è¢«æ£€æŸ¥
- å¤šä¸ªçˆ¶ç±»ä¼šæ ¹æ®å®ƒä»¬åœ¨åˆ—è¡¨ä¸­çš„é¡ºåºè¢«æ£€æŸ¥
- å¦‚æœå¯¹ä¸‹ä¸€ä¸ªç±»å­˜åœ¨ä¸¤ä¸ªåˆæ³•çš„é€‰æ‹©ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªçˆ¶ç±»

`super()` æœ‰ä¸ªä»¤äººåƒæƒŠçš„åœ°æ–¹æ˜¯å®ƒå¹¶ä¸ä¸€å®šå»æŸ¥æ‰¾æŸä¸ªç±»åœ¨MROä¸­ä¸‹ä¸€ä¸ªç›´æ¥çˆ¶ç±»ï¼Œç”šè‡³å¯ä»¥åœ¨ä¸€ä¸ªæ²¡æœ‰ç›´æ¥çˆ¶ç±»çš„ç±»ä¸­ä½¿ç”¨å®ƒã€‚ä¾‹å¦‚ï¼Œè€ƒè™‘å¦‚ä¸‹è¿™ä¸ªç±»ï¼š
```python
class A:
    def spam(self):
        print('A.spam')
        super().spam()

# >>> a = A()
# >>> a.spam()
# A.spam
# Traceback (most recent call last):
#     File "<stdin>", line 1, in <module>
#     File "<stdin>", line 4, in spam
# AttributeError: 'super' object has no attribute 'spam'
# >>>

>>> class B:
...     def spam(self):
...         print('B.spam')
...
>>> class C(A,B):
...     pass
...
>>> c = C()
>>> c.spam()
A.spam
B.spam
>>>
```

å¯ä»¥çœ‹åˆ°åœ¨ç±»Aä¸­ä½¿ç”¨ `super().spam()` å®é™…ä¸Šè°ƒç”¨çš„æ˜¯è·Ÿç±»Aæ¯«æ— å…³ç³»çš„ç±»Bä¸­çš„ `spam()` æ–¹æ³•ã€‚ è¿™ä¸ªç”¨ç±»Cçš„MROåˆ—è¡¨å°±å¯ä»¥å®Œå…¨è§£é‡Šæ¸…æ¥šäº†ï¼š
```python
>>> C.__mro__
(<class '__main__.C'>, <class '__main__.A'>, <class '__main__.B'>,
<class 'object'>)
>>>
```
æœ€åï¼Œåœ¨å®šä¹‰æ··å…¥ç±»çš„æ—¶å€™è¿™æ ·ä½¿ç”¨ `super()` æ˜¯å¾ˆæ™®éçš„ã€‚


#### ğŸ¯ å­ç±»ä¸­æ‰©å±•property

åœ¨å­ç±»ä¸­ï¼Œæ‰©å±•å®šä¹‰åœ¨çˆ¶ç±»ä¸­çš„ property çš„åŠŸèƒ½ã€‚
```python
class Person:
    def __init__(self, name):
        self.name = name

    # Getter function
    @property
    def name(self):
        return self._name

    # Setter function
    @name.setter
    def name(self, value):
        if not isinstance(value, str):
            raise TypeError('Expected a string')
        self._name = value

    # Deleter function
    @name.deleter
    def name(self):
        raise AttributeError("Can't delete attribute")


class SubPerson(Person):
    @property
    def name(self):
        print('Getting name')
        return super().name

    @name.setter
    def name(self, value):
        print('Setting name to', value)
        super(SubPerson, SubPerson).name.__set__(self, value)

    @name.deleter
    def name(self):
        print('Deleting name')
        super(SubPerson, SubPerson).name.__delete__(self)
```
ä½¿ç”¨è¿™ä¸ªæ–°ç±»ï¼š
```python
>>> s = SubPerson('Guido')
Setting name to Guido
>>> s.name
Getting name
'Guido'
>>> s.name = 'Larry'
Setting name to Larry
>>> s.name = 42
Traceback (most recent call last):
    File "<stdin>", line 1, in <module>
    File "example.py", line 16, in name
        raise TypeError('Expected a string')
TypeError: Expected a string
>>>
```
å¦‚æœä»…ä»…åªæƒ³æ‰©å±• property çš„æŸä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆå¯ä»¥åƒä¸‹é¢è¿™æ ·å†™ï¼š
```python
class SubPerson(Person):
    @Person.name.getter
    def name(self):
        print('Getting name')
        return super().name

class SubPerson(Person):
    @Person.name.setter
    def name(self, value):
        print('Setting name to', value)
        super(SubPerson, SubPerson).name.__set__(self, value)
```

åœ¨å­ç±»ä¸­æ‰©å±•ä¸€ä¸ª property å¯èƒ½ä¼šå¼•èµ·å¾ˆå¤šä¸æ˜“å¯Ÿè§‰çš„é—®é¢˜ï¼Œ å› ä¸ºä¸€ä¸ªpropertyå…¶å®æ˜¯ `getter`ã€`setter` å’Œ `deleter` æ–¹æ³•çš„é›†åˆï¼Œè€Œä¸æ˜¯å•ä¸ªæ–¹æ³•ã€‚ å› æ­¤ï¼Œæ‰©å±•ä¸€ä¸ª property çš„æ—¶å€™ï¼Œéœ€è¦å…ˆç¡®å®šæ˜¯å¦è¦é‡æ–°å®šä¹‰æ‰€æœ‰çš„æ–¹æ³•è¿˜æ˜¯è¯´åªä¿®æ”¹å…¶ä¸­æŸä¸€ä¸ªã€‚



åœ¨ç¬¬ä¸€ä¸ªä¾‹å­ä¸­ï¼Œæ‰€æœ‰çš„ property æ–¹æ³•éƒ½è¢«é‡æ–°å®šä¹‰ã€‚ åœ¨æ¯ä¸€ä¸ªæ–¹æ³•ä¸­ï¼Œä½¿ç”¨äº† `super()` æ¥è°ƒç”¨çˆ¶ç±»çš„å®ç°ã€‚



 åœ¨ `setter` å‡½æ•°ä¸­ä½¿ç”¨ `super(SubPerson, SubPerson).name.__set__(self, value)` çš„è¯­å¥æ˜¯æ²¡æœ‰é”™çš„ã€‚ ä¸ºäº†å§”æ‰˜ç»™ä¹‹å‰å®šä¹‰çš„setteræ–¹æ³•ï¼Œéœ€è¦å°†æ§åˆ¶æƒä¼ é€’ç»™ä¹‹å‰å®šä¹‰çš„nameå±æ€§çš„ `__set__()` æ–¹æ³•ã€‚ ä¸è¿‡ï¼Œè·å–è¿™ä¸ªæ–¹æ³•çš„å”¯ä¸€é€”å¾„æ˜¯ä½¿ç”¨ç±»å˜é‡è€Œä¸æ˜¯å®ä¾‹å˜é‡æ¥è®¿é—®å®ƒã€‚ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ä½¿ç”¨ `super(SubPerson, SubPerson)` çš„åŸå› ã€‚



å¦å¤–ï¼Œå¦‚æœåªæƒ³é‡å®šä¹‰å…¶ä¸­ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£åªä½¿ç”¨ @property æœ¬èº«æ˜¯ä¸å¤Ÿçš„ã€‚
```python
class SubPerson(Person):
    @property  # Doesn't work
    def name(self):
        print('Getting name')
        return super().name

# >>> s = SubPerson('Guido')
# Traceback (most recent call last):
#     File "<stdin>", line 1, in <module>
#     File "example.py", line 5, in __init__
#         self.name = name
# AttributeError: can't set attribute
# >>>

class SubPerson(Person):
    @Person.name.getter
    def name(self):
        print('Getting name')
        return super().name
```


#### ğŸ¯ åˆ›å»ºæ–°çš„ç±»æˆ–å®ä¾‹å±æ€§ï¼ˆæè¿°å™¨ï¼‰

åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å®ä¾‹å±æ€§ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªæè¿°å™¨ç±»çš„å½¢å¼æ¥å®šä¹‰å®ƒçš„åŠŸèƒ½ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š
```python
# Descriptor attribute for an integer type-checked attribute
class Integer:
    def __init__(self, name):
        self.name = name

    def __get__(self, instance, cls):
        if instance is None:
            return self
        else:
            return instance.__dict__[self.name]

    def __set__(self, instance, value):
        if not isinstance(value, int):
            raise TypeError('Expected an int')
        instance.__dict__[self.name] = value

    def __delete__(self, instance):
        del instance.__dict__[self.name]
```

ä¸€ä¸ªæè¿°å™¨å°±æ˜¯ä¸€ä¸ªå®ç°äº†ä¸‰ä¸ªæ ¸å¿ƒçš„å±æ€§è®¿é—®æ“ä½œ(get, set, delete)çš„ç±»ï¼Œ åˆ†åˆ«ä¸º `__get__()` ã€`__set__()` å’Œ `__delete__()` è¿™ä¸‰ä¸ªç‰¹æ®Šçš„æ–¹æ³•ã€‚ è¿™äº›æ–¹æ³•æ¥å—ä¸€ä¸ªå®ä¾‹ä½œä¸ºè¾“å…¥ï¼Œä¹‹åç›¸åº”çš„æ“ä½œå®ä¾‹åº•å±‚çš„å­—å…¸ã€‚

ä¸ºäº†ä½¿ç”¨ä¸€ä¸ªæè¿°å™¨ï¼Œéœ€å°†è¿™ä¸ªæè¿°å™¨çš„å®ä¾‹ä½œä¸ºç±»å±æ€§æ”¾åˆ°ä¸€ä¸ªç±»çš„å®šä¹‰ä¸­ã€‚ä¾‹å¦‚ï¼š
```python
class Point:
    x = Integer('x')
    y = Integer('y')

    def __init__(self, x, y):
        self.x = x
        self.y = y
```
è¿™æ ·åšåï¼Œæ‰€æœ‰å¯¹æè¿°å™¨å±æ€§(æ¯”å¦‚xæˆ–y)çš„è®¿é—®ä¼šè¢« `__get__()` ã€`__set__()` å’Œ `__delete__()` æ–¹æ³•æ•è·åˆ°ã€‚ä¾‹å¦‚ï¼š
```python
>>> p = Point(2, 3)
>>> p.x # Calls Point.x.__get__(p,Point)
2
>>> p.y = 5 # Calls Point.y.__set__(p, 5)
>>> p.x = 2.3 # Calls Point.x.__set__(p, 2.3)
Traceback (most recent call last):
    File "<stdin>", line 1, in <module>
    File "descrip.py", line 12, in __set__
        raise TypeError('Expected an int')
TypeError: Expected an int
>>>
```
ä½œä¸ºè¾“å…¥ï¼Œæè¿°å™¨çš„æ¯ä¸€ä¸ªæ–¹æ³•ä¼šæ¥å—ä¸€ä¸ªæ“ä½œå®ä¾‹ã€‚ ä¸ºäº†å®ç°è¯·æ±‚æ“ä½œï¼Œä¼šç›¸åº”çš„æ“ä½œå®ä¾‹åº•å±‚çš„å­—å…¸(__dict__å±æ€§)ã€‚ æè¿°å™¨çš„ `self.name` å±æ€§å­˜å‚¨äº†åœ¨å®ä¾‹å­—å…¸ä¸­è¢«å®é™…ä½¿ç”¨åˆ°çš„keyã€‚

æè¿°å™¨å¯å®ç°å¤§éƒ¨åˆ†Pythonç±»ç‰¹æ€§ä¸­çš„åº•å±‚é­”æ³•ï¼Œ åŒ…æ‹¬ `@classmethod` ã€`@staticmethod` ã€`@property` ï¼Œç”šè‡³æ˜¯ `__slots__`ç‰¹æ€§ã€‚

é€šè¿‡å®šä¹‰ä¸€ä¸ªæè¿°å™¨ï¼Œå¯ä»¥åœ¨åº•å±‚æ•è·æ ¸å¿ƒçš„å®ä¾‹æ“ä½œ(get, set, delete)ï¼Œå¹¶ä¸”å¯å®Œå…¨è‡ªå®šä¹‰å®ƒä»¬çš„è¡Œä¸ºã€‚ è¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œæœ‰äº†å®ƒå¯ä»¥å®ç°å¾ˆå¤šé«˜çº§åŠŸèƒ½ï¼Œå¹¶ä¸”å®ƒä¹Ÿæ˜¯å¾ˆå¤šé«˜çº§åº“å’Œæ¡†æ¶ä¸­çš„é‡è¦å·¥å…·ä¹‹ä¸€ã€‚

æè¿°å™¨çš„ä¸€ä¸ªæ¯”è¾ƒå›°æƒ‘çš„åœ°æ–¹æ˜¯å®ƒåªèƒ½åœ¨ç±»çº§åˆ«è¢«å®šä¹‰ï¼Œè€Œä¸èƒ½ä¸ºæ¯ä¸ªå®ä¾‹å•ç‹¬å®šä¹‰ã€‚å› æ­¤ï¼Œä¸‹é¢çš„ä»£ç æ˜¯æ— æ³•å·¥ä½œçš„ï¼š
```python
# Does NOT work
class Point:
    def __init__(self, x, y):
        self.x = Integer('x') # No! Must be a class variable
        self.y = Integer('y')
        self.x = x
        self.y = y
```
åŸå› æ˜¯ï¼šå®ä¾‹å­—å…¸ä¸­çš„å±æ€§ä¸ä¼šè§¦å‘æè¿°å™¨åè®®ï¼Œæè¿°å™¨ä»…åœ¨ç±»å±æ€§ä¸­ç”Ÿæ•ˆã€‚ä¿æŒç±»çš„ç»Ÿä¸€æ¥å£ã€‚

åŒæ—¶ï¼Œ`__get__()` æ–¹æ³•å®ç°èµ·æ¥æ¯”çœ‹ä¸Šå»è¦å¤æ‚å¾—å¤šï¼š
```python
# Descriptor attribute for an integer type-checked attribute
class Integer:

    def __get__(self, instance, cls):
        if instance is None:
            return self
        else:
            return instance.__dict__[self.name]
```
`__get__()` çœ‹ä¸Šå»æœ‰ç‚¹å¤æ‚çš„åŸå› å½’ç»“äºå®ä¾‹å˜é‡å’Œç±»å˜é‡çš„ä¸åŒã€‚ å¦‚æœä¸€ä¸ªæè¿°å™¨è¢«å½“åšä¸€ä¸ªç±»å˜é‡æ¥è®¿é—®ï¼Œé‚£ä¹ˆ `instance`å‚æ•°è¢«è®¾ç½®æˆ None ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ ‡å‡†åšæ³•å°±æ˜¯ç®€å•çš„è¿”å›è¿™ä¸ªæè¿°å™¨æœ¬èº«å³å¯(å°½ç®¡è¿˜å¯ä»¥æ·»åŠ å…¶ä»–çš„è‡ªå®šä¹‰æ“ä½œ)ã€‚ä¾‹å¦‚ï¼š
```python
>>> p = Point(2,3)
>>> p.x # Calls Point.x.__get__(p, Point)
2
>>> Point.x # Calls Point.x.__get__(None, Point)
<__main__.Integer object at 0x100671890>
>>>
```

é«˜çº§ç”¨æ³•ï¼š
```python
# Descriptor for a type-checked attribute
class Typed:
    def __init__(self, name, expected_type):
        self.name = name
        self.expected_type = expected_type
    def __get__(self, instance, cls):
        if instance is None:
            return self
        else:
            return instance.__dict__[self.name]

    def __set__(self, instance, value):
        if not isinstance(value, self.expected_type):
            raise TypeError('Expected ' + str(self.expected_type))
        instance.__dict__[self.name] = value
    def __delete__(self, instance):
        del instance.__dict__[self.name]

# Class decorator that applies it to selected attributes
def typeassert(**kwargs):
    def decorate(cls):
        for name, expected_type in kwargs.items():
            # Attach a Typed descriptor to the class
            setattr(cls, name, Typed(name, expected_type))
        return cls
    return decorate

# Example use
@typeassert(name=str, shares=int, price=float)
class Stock:
    def __init__(self, name, shares, price):
        self.name = name
        self.shares = shares
        self.price = price
```
æœ€åè¦æŒ‡å‡ºçš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœåªæ˜¯æƒ³ç®€å•çš„è‡ªå®šä¹‰æŸä¸ªç±»çš„å•ä¸ªå±æ€§è®¿é—®çš„è¯å°±ä¸ç”¨å»å†™æè¿°å™¨äº†ã€‚ è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨ property æŠ€æœ¯ä¼šæ›´åŠ å®¹æ˜“ã€‚ 

å½“ç¨‹åºä¸­æœ‰å¾ˆå¤šé‡å¤ä»£ç çš„æ—¶å€™æè¿°å™¨å°±å¾ˆæœ‰ç”¨äº† (æ¯”å¦‚æƒ³åœ¨ä»£ç çš„å¾ˆå¤šåœ°æ–¹ä½¿ç”¨æè¿°å™¨æä¾›çš„åŠŸèƒ½æˆ–è€…å°†å®ƒä½œä¸ºä¸€ä¸ªå‡½æ•°åº“ç‰¹æ€§)ã€‚


#### ğŸ¯ ä½¿ç”¨å»¶è¿Ÿè®¡ç®—å±æ€§
æƒ³å°†ä¸€ä¸ªåªè¯»å±æ€§å®šä¹‰æˆä¸€ä¸ªpropertyï¼Œå¹¶ä¸”åªåœ¨è®¿é—®çš„æ—¶å€™æ‰ä¼šè®¡ç®—ç»“æœã€‚ ä½†æ˜¯ä¸€æ—¦è¢«è®¿é—®åï¼Œå¸Œæœ›ç»“æœå€¼è¢«ç¼“å­˜èµ·æ¥ï¼Œä¸ç”¨æ¯æ¬¡éƒ½å»è®¡ç®—ã€‚

å®šä¹‰ä¸€ä¸ªå»¶è¿Ÿå±æ€§çš„ä¸€ç§é«˜æ•ˆæ–¹æ³•æ˜¯é€šè¿‡ä½¿ç”¨ä¸€ä¸ªæè¿°å™¨ç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```python
class lazyproperty:
    def __init__(self, func):
        self.func = func

    def __get__(self, instance, cls):
        if instance is None:
            return self
        else:
            value = self.func(instance)
            setattr(instance, self.func.__name__, value)
            return value

import math

class Circle:
    def __init__(self, radius):
        self.radius = radius

    @lazyproperty
    def area(self):
        print('Computing area')
        return math.pi * self.radius ** 2

    @lazyproperty
    def perimeter(self):
        print('Computing perimeter')
        return 2 * math.pi * self.radius
```

ä¸‹é¢åœ¨ä¸€ä¸ªäº¤äº’ç¯å¢ƒä¸­æ¼”ç¤ºå®ƒçš„ä½¿ç”¨ï¼š
```python
>>> c = Circle(4.0)
>>> c.radius
4.0
>>> c.area
Computing area
50.26548245743669
>>> c.area
50.26548245743669
>>> c.perimeter
Computing perimeter
25.132741228718345
>>> c.perimeter
25.132741228718345
>>>
```

å¾ˆå¤šæ—¶å€™ï¼Œæ„é€ ä¸€ä¸ªå»¶è¿Ÿè®¡ç®—å±æ€§çš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†æå‡æ€§èƒ½ã€‚ ä¾‹å¦‚ï¼Œå¯ä»¥é¿å…è®¡ç®—è¿™äº›å±æ€§å€¼ï¼Œé™¤éçœŸçš„éœ€è¦å®ƒä»¬ã€‚ è¿™é‡Œæ¼”ç¤ºçš„æ–¹æ¡ˆå°±æ˜¯ç”¨æ¥å®ç°è¿™æ ·çš„æ•ˆæœçš„ï¼Œ åªä¸è¿‡å®ƒæ˜¯é€šè¿‡ä»¥éå¸¸é«˜æ•ˆçš„æ–¹å¼ä½¿ç”¨æè¿°å™¨çš„ä¸€ä¸ªç²¾å¦™ç‰¹æ€§æ¥è¾¾åˆ°è¿™ç§æ•ˆæœçš„ã€‚

å½“ä¸€ä¸ªæè¿°å™¨è¢«æ”¾å…¥ä¸€ä¸ªç±»çš„å®šä¹‰æ—¶ï¼Œ æ¯æ¬¡è®¿é—®å±æ€§æ—¶å®ƒçš„ `__get__()` ã€`__set__()` å’Œ `__delete__()` æ–¹æ³•å°±ä¼šè¢«è§¦å‘ã€‚ ä¸è¿‡ï¼Œå¦‚æœä¸€ä¸ªæè¿°å™¨ä»…ä»…åªå®šä¹‰äº†ä¸€ä¸ª `__get__()` æ–¹æ³•çš„è¯ï¼Œå®ƒæ¯”é€šå¸¸çš„å…·æœ‰æ›´å¼±çš„ç»‘å®šã€‚ ç‰¹åˆ«åœ°ï¼Œåªæœ‰å½“è¢«è®¿é—®å±æ€§ä¸åœ¨å®ä¾‹åº•å±‚çš„å­—å…¸ä¸­æ—¶ `__get__()` æ–¹æ³•æ‰ä¼šè¢«è§¦å‘ã€‚

lazyproperty ç±»åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œä½¿ç”¨ `__get__()` æ–¹æ³•åœ¨å®ä¾‹ä¸­å­˜å‚¨è®¡ç®—å‡ºæ¥çš„å€¼ï¼Œ è¿™ä¸ªå®ä¾‹ä½¿ç”¨ç›¸åŒçš„åå­—ä½œä¸ºå®ƒçš„propertyã€‚ è¿™æ ·ä¸€æ¥ï¼Œç»“æœå€¼è¢«å­˜å‚¨åœ¨å®ä¾‹å­—å…¸ä¸­å¹¶ä¸”ä»¥åå°±ä¸éœ€è¦å†å»è®¡ç®—è¿™ä¸ªpropertyäº†ã€‚


#### ğŸ¯ å®šä¹‰æ¥å£æˆ–è€…æŠ½è±¡åŸºç±»
æƒ³å®šä¹‰ä¸€ä¸ªæ¥å£æˆ–æŠ½è±¡ç±»ï¼Œå¹¶ä¸”é€šè¿‡æ‰§è¡Œç±»å‹æ£€æŸ¥æ¥ç¡®ä¿å­ç±»å®ç°äº†æŸäº›ç‰¹å®šçš„æ–¹æ³•ã€‚

ä½¿ç”¨ abc æ¨¡å—å¯ä»¥å¾ˆè½»æ¾çš„å®šä¹‰æŠ½è±¡åŸºç±»ï¼š
```python
from abc import ABCMeta, abstractmethod

class IStream(metaclass=ABCMeta):
    @abstractmethod
    def read(self, maxbytes=-1):
        pass

    @abstractmethod
    def write(self, data):
        pass
```

æŠ½è±¡ç±»çš„ä¸€ä¸ªç‰¹ç‚¹æ˜¯å®ƒä¸èƒ½ç›´æ¥è¢«å®ä¾‹åŒ–ï¼Œæ¯”å¦‚æƒ³åƒä¸‹é¢è¿™æ ·åšæ˜¯ä¸è¡Œçš„ï¼š
```python
a = IStream() # TypeError: Can't instantiate abstract class
                # IStream with abstract methods read, write
```
æŠ½è±¡ç±»çš„ç›®çš„å°±æ˜¯è®©åˆ«çš„ç±»ç»§æ‰¿å®ƒå¹¶å®ç°ç‰¹å®šçš„æŠ½è±¡æ–¹æ³•ï¼š
```python
class SocketStream(IStream):
    def read(self, maxbytes=-1):
        pass

    def write(self, data):
        pass
```
æŠ½è±¡åŸºç±»çš„ä¸€ä¸ªä¸»è¦ç”¨é€”æ˜¯åœ¨ä»£ç ä¸­æ£€æŸ¥æŸäº›ç±»æ˜¯å¦ä¸ºç‰¹å®šç±»å‹ï¼Œå®ç°äº†ç‰¹å®šæ¥å£ï¼š
```python
def serialize(obj, stream):
    if not isinstance(stream, IStream):
        raise TypeError('Expected an IStream')
    pass
```

#### ğŸ¯ å±æ€§çš„ä»£ç†è®¿é—®

å¦‚æœæœ‰å¤§é‡çš„æ–¹æ³•éœ€è¦ä»£ç†ï¼Œ é‚£ä¹ˆä½¿ç”¨ `__getattr__()` æ–¹æ³•
```python
class B2:
    """ä½¿ç”¨__getattr__çš„ä»£ç†ï¼Œä»£ç†æ–¹æ³•æ¯”è¾ƒå¤šæ—¶å€™"""

    def __init__(self):
        self._a = A()

    def bar(self):
        pass

    # Expose all of the methods defined on class A
    def __getattr__(self, name):
        """è¿™ä¸ªæ–¹æ³•åœ¨è®¿é—®çš„attributeä¸å­˜åœ¨çš„æ—¶å€™è¢«è°ƒç”¨
        the __getattr__() method is actually a fallback method
        that only gets called when an attribute is not found"""
        return getattr(self._a, name)
```
`__getattr__` æ–¹æ³•æ˜¯åœ¨è®¿é—®attributeä¸å­˜åœ¨çš„æ—¶å€™è¢«è°ƒç”¨


#### ğŸ¯ åœ¨ç±»ä¸­å®šä¹‰å¤šä¸ªæ„é€ å™¨

ä¸ºäº†å®ç°å¤šä¸ªæ„é€ å™¨ï¼Œéœ€è¦ä½¿ç”¨åˆ°ç±»æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š
```python
import time

class Date:
    """æ–¹æ³•ä¸€ï¼šä½¿ç”¨ç±»æ–¹æ³•"""
    # Primary constructor
    def __init__(self, year, month, day):
        self.year = year
        self.month = month
        self.day = day

    # Alternate constructor
    @classmethod
    def today(cls):
        t = time.localtime()
        return cls(t.tm_year, t.tm_mon, t.tm_mday)
```
ç›´æ¥è°ƒç”¨ç±»æ–¹æ³•å³å¯ï¼Œä¸‹é¢æ˜¯ä½¿ç”¨ç¤ºä¾‹ï¼š
```python
a = Date(2012, 12, 21) # Primary
b = Date.today() # Alternate
```
ç±»æ–¹æ³•çš„ä¸€ä¸ªä¸»è¦ç”¨é€”å°±æ˜¯å®šä¹‰å¤šä¸ªæ„é€ å™¨ã€‚å®ƒæ¥å—ä¸€ä¸ª class ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°(cls)ã€‚ åº”è¯¥æ³¨æ„åˆ°äº†è¿™ä¸ªç±»è¢«ç”¨æ¥åˆ›å»ºå¹¶è¿”å›æœ€ç»ˆçš„å®ä¾‹ã€‚


#### ğŸ¯ åˆ›å»ºä¸è°ƒç”¨initæ–¹æ³•çš„å®ä¾‹
æƒ³åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œä½†æ˜¯å¸Œæœ›ç»•è¿‡æ‰§è¡Œ `__init__()` æ–¹æ³•ã€‚å¯ä»¥é€šè¿‡ `__new__()` æ–¹æ³•åˆ›å»ºä¸€ä¸ªæœªåˆå§‹åŒ–çš„å®ä¾‹ã€‚ä¾‹å¦‚è€ƒè™‘å¦‚ä¸‹è¿™ä¸ªç±»ï¼š
```python
class Date:
    def __init__(self, year, month, day):
        self.year = year
        self.month = month
        self.day = day

>>> d = Date.__new__(Date)
>>> d
<__main__.Date object at 0x1006716d0>
>>> d.year
Traceback (most recent call last):
    File "<stdin>", line 1, in <module>
AttributeError: 'Date' object has no attribute 'year'
>>>
```

ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªDateå®ä¾‹çš„å±æ€§yearè¿˜ä¸å­˜åœ¨ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨åˆå§‹åŒ–ï¼š
```python
>>> data = {'year':2012, 'month':8, 'day':29}
>>> for key, value in data.items():
...     setattr(d, key, value)
...
>>> d.year
2012
>>> d.month
8
>>>
```


#### ğŸ¯ åˆ©ç”¨Mixinsæ‰©å±•ç±»åŠŸèƒ½
æœ‰å¾ˆå¤šæœ‰ç”¨çš„æ–¹æ³•ï¼Œæƒ³ä½¿ç”¨å®ƒä»¬æ¥æ‰©å±•å…¶ä»–ç±»çš„åŠŸèƒ½ã€‚ä½†æ˜¯è¿™äº›ç±»å¹¶æ²¡æœ‰ä»»ä½•ç»§æ‰¿çš„å…³ç³»ã€‚ å› æ­¤ä¸èƒ½ç®€å•çš„å°†è¿™äº›æ–¹æ³•æ”¾å…¥ä¸€ä¸ªåŸºç±»ï¼Œç„¶åè¢«å…¶ä»–ç±»ç»§æ‰¿ã€‚

é€šå¸¸å½“æƒ³è‡ªå®šä¹‰ç±»çš„æ—¶å€™ä¼šç¢°ä¸Šè¿™äº›é—®é¢˜ã€‚å¯èƒ½æ˜¯æŸä¸ªåº“æä¾›äº†ä¸€äº›åŸºç¡€ç±»ï¼Œ å¯ä»¥åˆ©ç”¨å®ƒä»¬æ¥æ„é€ è‡ªå·±çš„ç±»ã€‚

å‡è®¾æƒ³æ‰©å±•æ˜ å°„å¯¹è±¡ï¼Œç»™å®ƒä»¬æ·»åŠ æ—¥å¿—ã€å”¯ä¸€æ€§è®¾ç½®ã€ç±»å‹æ£€æŸ¥ç­‰ç­‰åŠŸèƒ½ã€‚ä¸‹é¢æ˜¯ä¸€äº›æ··å…¥ç±»ï¼š
```python
class LoggedMappingMixin:
    """
    Add logging to get/set/delete operations for debugging.
    """
    __slots__ = ()  # æ··å…¥ç±»éƒ½æ²¡æœ‰å®ä¾‹å˜é‡ï¼Œå› ä¸ºç›´æ¥å®ä¾‹åŒ–æ··å…¥ç±»æ²¡æœ‰ä»»ä½•æ„ä¹‰

    def __getitem__(self, key):
        print('Getting ' + str(key))
        return super().__getitem__(key)

    def __setitem__(self, key, value):
        print('Setting {} = {!r}'.format(key, value))
        return super().__setitem__(key, value)

    def __delitem__(self, key):
        print('Deleting ' + str(key))
        return super().__delitem__(key)


class SetOnceMappingMixin:
    '''
    Only allow a key to be set once.
    '''
    __slots__ = ()

    def __setitem__(self, key, value):
        if key in self:
            raise KeyError(str(key) + ' already set')
        return super().__setitem__(key, value)


class StringKeysMappingMixin:
    '''
    Restrict keys to strings only
    '''
    __slots__ = ()

    def __setitem__(self, key, value):
        if not isinstance(key, str):
            raise TypeError('keys must be strings')
        return super().__setitem__(key, value)
```

è¿™äº›ç±»å•ç‹¬ä½¿ç”¨èµ·æ¥æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œäº‹å®ä¸Šå¦‚æœå»å®ä¾‹åŒ–ä»»ä½•ä¸€ä¸ªç±»ï¼Œé™¤äº†äº§ç”Ÿå¼‚å¸¸å¤–æ²¡ä»»ä½•ä½œç”¨ã€‚ å®ƒä»¬æ˜¯ç”¨æ¥é€šè¿‡å¤šç»§æ‰¿æ¥å’Œå…¶ä»–æ˜ å°„å¯¹è±¡æ··å…¥ä½¿ç”¨çš„ã€‚ä¾‹å¦‚ï¼š
```python
class LoggedDict(LoggedMappingMixin, dict):
    pass

d = LoggedDict()
d['x'] = 23
print(d['x'])
del d['x']

from collections import defaultdict

class SetOnceDefaultDict(SetOnceMappingMixin, defaultdict):
    pass


d = SetOnceDefaultDict(list)
d['x'].append(2)
d['x'].append(3)
# d['x'] = 23  # KeyError: 'x already set'
```

è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ··å…¥ç±»è·Ÿå…¶ä»–å·²å­˜åœ¨çš„ç±»(æ¯”å¦‚dictã€defaultdictå’ŒOrderedDict)ç»“åˆèµ·æ¥ä½¿ç”¨ï¼Œä¸€ä¸ªæ¥ä¸€ä¸ªã€‚ ç»“åˆåå°±èƒ½å‘æŒ¥æ­£å¸¸åŠŸæ•ˆäº†ã€‚

å¯¹äºæ··å…¥ç±»ï¼Œæœ‰å‡ ç‚¹éœ€è¦è®°ä½ã€‚é¦–å…ˆæ˜¯ï¼Œæ··å…¥ç±»ä¸èƒ½ç›´æ¥è¢«å®ä¾‹åŒ–ä½¿ç”¨ã€‚ å…¶æ¬¡ï¼Œæ··å…¥ç±»æ²¡æœ‰è‡ªå·±çš„çŠ¶æ€ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬å¹¶æ²¡æœ‰å®šä¹‰ `__init__()` æ–¹æ³•ï¼Œå¹¶ä¸”æ²¡æœ‰å®ä¾‹å±æ€§ã€‚ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä¸Šé¢æ˜ç¡®å®šä¹‰äº† `__slots__ = ()`ã€‚


#### ğŸ¯ å®ç°çŠ¶æ€å¯¹è±¡æˆ–è€…çŠ¶æ€æœº
æƒ³å®ç°ä¸€ä¸ªçŠ¶æ€æœºæˆ–è€…æ˜¯åœ¨ä¸åŒçŠ¶æ€ä¸‹æ‰§è¡Œæ“ä½œçš„å¯¹è±¡ï¼Œä½†æ˜¯åˆä¸æƒ³åœ¨ä»£ç ä¸­å‡ºç°å¤ªå¤šçš„æ¡ä»¶åˆ¤æ–­è¯­å¥ã€‚

åœ¨å¾ˆå¤šç¨‹åºä¸­ï¼Œæœ‰äº›å¯¹è±¡ä¼šæ ¹æ®çŠ¶æ€çš„ä¸åŒæ¥æ‰§è¡Œä¸åŒçš„æ“ä½œã€‚æ¯”å¦‚è€ƒè™‘å¦‚ä¸‹çš„ä¸€ä¸ªè¿æ¥å¯¹è±¡ï¼š
```python
class Connection:
    """æ™®é€šæ–¹æ¡ˆï¼Œå¥½å¤šä¸ªåˆ¤æ–­è¯­å¥ï¼Œæ•ˆç‡ä½ä¸‹~~"""

    def __init__(self):
        self.state = 'CLOSED'

    def read(self):
        if self.state != 'OPEN':
            raise RuntimeError('Not open')
        print('reading')

    def write(self, data):
        if self.state != 'OPEN':
            raise RuntimeError('Not open')
        print('writing')

    def open(self):
        if self.state == 'OPEN':
            raise RuntimeError('Already open')
        self.state = 'OPEN'

    def close(self):
        if self.state == 'CLOSED':
            raise RuntimeError('Already closed')
        self.state = 'CLOSED'
```

è¿™æ ·å†™æœ‰å¾ˆå¤šç¼ºç‚¹ï¼Œé¦–å…ˆæ˜¯ä»£ç å¤ªå¤æ‚äº†ï¼Œå¥½å¤šçš„æ¡ä»¶åˆ¤æ–­ã€‚å…¶æ¬¡æ˜¯æ‰§è¡Œæ•ˆç‡å˜ä½ï¼Œ å› ä¸ºä¸€äº›å¸¸è§çš„æ“ä½œæ¯”å¦‚read()ã€write()æ¯æ¬¡æ‰§è¡Œå‰éƒ½éœ€è¦æ‰§è¡Œæ£€æŸ¥ã€‚

ä¸€ä¸ªæ›´å¥½çš„åŠæ³•æ˜¯ä¸ºæ¯ä¸ªçŠ¶æ€å®šä¹‰ä¸€ä¸ªå¯¹è±¡ï¼š
```python
class Connection:
    """æ–°æ–¹æ¡ˆâ€”â€”å¯¹æ¯ä¸ªçŠ¶æ€å®šä¹‰ä¸€ä¸ªç±»"""

    def __init__(self):
        self.new_state(ClosedConnectionState)

    def new_state(self, newstate):
        self._state = newstate
        # Delegate to the state class

    def read(self):
        return self._state.read(self)

    def write(self, data):
        return self._state.write(self, data)

    def open(self):
        return self._state.open(self)

    def close(self):
        return self._state.close(self)


# Connection state base class
class ConnectionState:
    @staticmethod
    def read(conn):
        raise NotImplementedError()

    @staticmethod
    def write(conn, data):
        raise NotImplementedError()

    @staticmethod
    def open(conn):
        raise NotImplementedError()

    @staticmethod
    def close(conn):
        raise NotImplementedError()


# Implementation of different states
class ClosedConnectionState(ConnectionState):
    @staticmethod
    def read(conn):
        raise RuntimeError('Not open')

    @staticmethod
    def write(conn, data):
        raise RuntimeError('Not open')

    @staticmethod
    def open(conn):
        conn.new_state(OpenConnectionState)

    @staticmethod
    def close(conn):
        raise RuntimeError('Already closed')


class OpenConnectionState(ConnectionState):
    @staticmethod
    def read(conn):
        print('reading')

    @staticmethod
    def write(conn, data):
        print('writing')

    @staticmethod
    def open(conn):
        raise RuntimeError('Already open')

    @staticmethod
    def close(conn):
        conn.new_state(ClosedConnectionState)
```

ä½¿ç”¨ç¤ºä¾‹ï¼š
```python
>>> c = Connection()
>>> c._state
<class '__main__.ClosedConnectionState'>
>>> c.read()
Traceback (most recent call last):
    File "<stdin>", line 1, in <module>
    File "example.py", line 10, in read
        return self._state.read(self)
    File "example.py", line 43, in read
        raise RuntimeError('Not open')
RuntimeError: Not open
>>> c.open()
>>> c._state
<class '__main__.OpenConnectionState'>
>>> c.read()
reading
>>> c.write('hello')
writing
>>> c.close()
>>> c._state
<class '__main__.ClosedConnectionState'>
>>>
```

#### ğŸ¯ å®ç°è®¿é—®è€…æ¨¡å¼
è¦å¤„ç†ç”±å¤§é‡ä¸åŒç±»å‹çš„å¯¹è±¡ç»„æˆçš„å¤æ‚æ•°æ®ç»“æ„ï¼Œæ¯ä¸€ä¸ªå¯¹è±¡éƒ½éœ€è¦è¿›è¡Œä¸åŒçš„å¤„ç†ã€‚ æ¯”å¦‚ï¼Œéå†ä¸€ä¸ªæ ‘å½¢ç»“æ„ï¼Œç„¶åæ ¹æ®æ¯ä¸ªèŠ‚ç‚¹çš„ç›¸åº”çŠ¶æ€æ‰§è¡Œä¸åŒçš„æ“ä½œã€‚

è¿™é‡Œé‡åˆ°çš„é—®é¢˜åœ¨ç¼–ç¨‹é¢†åŸŸä¸­æ˜¯å¾ˆæ™®éçš„ï¼Œæœ‰æ—¶å€™ä¼šæ„å»ºä¸€ä¸ªç”±å¤§é‡ä¸åŒå¯¹è±¡ç»„æˆçš„æ•°æ®ç»“æ„ã€‚ å‡è®¾è¦å†™ä¸€ä¸ªè¡¨ç¤ºæ•°å­¦è¡¨è¾¾å¼çš„ç¨‹åºï¼Œé‚£ä¹ˆå¯èƒ½éœ€è¦å®šä¹‰å¦‚ä¸‹çš„ç±»ï¼š
```python
class Node:
    pass

class UnaryOperator(Node):
    def __init__(self, operand):
        self.operand = operand

class BinaryOperator(Node):
    def __init__(self, left, right):
        self.left = left
        self.right = right


class Number(Node):
    def __init__(self, value):
        self.value = value


class Add(BinaryOperator):
    pass

class Sub(BinaryOperator):
    pass

class Mul(BinaryOperator):
    pass

class Div(BinaryOperator):
    pass

class Negate(UnaryOperator):
    pass
```

ç„¶ååˆ©ç”¨è¿™äº›ç±»æ„å»ºåµŒå¥—æ•°æ®ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```python
# Representation of 1 + 2 * (3 - 4) / 5
t1 = Sub(Number(3), Number(4))
t2 = Mul(Number(2), t1)
t3 = Div(t2, Number(5))
t4 = Add(Number(1), t3)
```

è¿™æ ·åšçš„é—®é¢˜æ˜¯å¯¹äºæ¯ä¸ªè¡¨è¾¾å¼ï¼Œæ¯æ¬¡éƒ½è¦é‡æ–°å®šä¹‰ä¸€éï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡å®šä¹‰ä¸€ä¸ªæ–°çš„è¡¨è¾¾å¼æ—¶ï¼Œéƒ½å¿…é¡»é‡æ–°ä»å¤´å¼€å§‹æ„å»ºè¿™äº›å­è¡¨è¾¾å¼ã€‚è¿™æ„å‘³ç€å¿…é¡»æ‰‹åŠ¨åˆ›å»ºæ‰€æœ‰çš„å­èŠ‚ç‚¹ï¼Œå¹¶ä¸”ä¸€æ—¦æ”¹å˜æŸéƒ¨åˆ†çš„ç»“æ„ï¼ˆä¾‹å¦‚ï¼Œæ”¹å˜æ“ä½œç¬¦æˆ–æ“ä½œæ•°ï¼‰ï¼Œå¯èƒ½éœ€è¦é‡æ–°ç»„ç»‡æ•´ä¸ªè¡¨è¾¾å¼æ ‘ã€‚

æœ‰æ²¡æœ‰ä¸€ç§æ›´é€šç”¨çš„æ–¹å¼è®©å®ƒæ”¯æŒæ‰€æœ‰çš„æ•°å­—å’Œæ“ä½œç¬¦å‘¢ã€‚ è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨è®¿é—®è€…æ¨¡å¼å¯ä»¥è¾¾åˆ°è¿™æ ·çš„ç›®çš„ï¼š
```python
class NodeVisitor:
    def visit(self, node):
        methname = 'visit_' + type(node).__name__
        meth = getattr(self, methname, None)
        if meth is None:
            meth = self.generic_visit
        return meth(node)

    def generic_visit(self, node):
        raise RuntimeError('No {} method'.format('visit_' + type(node).__name__))
```

ä¸ºäº†ä½¿ç”¨è¿™ä¸ªç±»ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªç±»ç»§æ‰¿å®ƒå¹¶ä¸”å®ç°å„ç§ `visit_Name()` æ–¹æ³•ï¼Œå…¶ä¸­Nameæ˜¯nodeç±»å‹ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæƒ³æ±‚è¡¨è¾¾å¼çš„å€¼ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š
```python
class Evaluator(NodeVisitor):
    def visit_Number(self, node):
        return node.value

    def visit_Add(self, node):
        return self.visit(node.left) + self.visit(node.right)

    def visit_Sub(self, node):
        return self.visit(node.left) - self.visit(node.right)

    def visit_Mul(self, node):
        return self.visit(node.left) * self.visit(node.right)

    def visit_Div(self, node):
        return self.visit(node.left) / self.visit(node.right)

    def visit_Negate(self, node):
        return -node.operand


>>> e = Evaluator()
>>> e.visit(t4)
0.6
>>>
```

âš ï¸ä½¿ç”¨è®¿é—®è€…æ¨¡å¼éå†ä¸€ä¸ªå¾ˆæ·±çš„åµŒå¥—æ ‘å½¢æ•°æ®ç»“æ„ï¼Œå¹¶ä¸”å› ä¸ºè¶…è¿‡åµŒå¥—å±‚çº§é™åˆ¶è€Œå¤±è´¥ã€‚ æƒ³æ¶ˆé™¤é€’å½’ï¼Œå¹¶åŒæ—¶ä¿æŒè®¿é—®è€…ç¼–ç¨‹æ¨¡å¼ã€‚

é€šè¿‡å·§å¦™çš„ä½¿ç”¨ç”Ÿæˆå™¨å¯ä»¥åœ¨æ ‘éå†æˆ–æœç´¢ç®—æ³•ä¸­æ¶ˆé™¤é€’å½’ã€‚ åœ¨8.21å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ç»™å‡ºäº†ä¸€ä¸ªè®¿é—®è€…ç±»ã€‚ ä¸‹é¢æˆ‘ä»¬åˆ©ç”¨ä¸€ä¸ªæ ˆå’Œç”Ÿæˆå™¨é‡æ–°å®ç°è¿™ä¸ªç±»ï¼š
```python
import types

class Node:
    pass

class NodeVisitor:
    def visit(self, node):
        stack = [node]
        last_result = None
        while stack:
            try:
                last = stack[-1]
                if isinstance(last, types.GeneratorType):
                    stack.append(last.send(last_result))
                    last_result = None
                elif isinstance(last, Node):
                    stack.append(self._visit(stack.pop()))
                else:
                    last_result = stack.pop()
            except StopIteration:
                stack.pop()

        return last_result

    def _visit(self, node):
        methname = 'visit_' + type(node).__name__
        meth = getattr(self, methname, None)
        if meth is None:
            meth = self.generic_visit
        return meth(node)

    def generic_visit(self, node):
        raise RuntimeError('No {} method'.format('visit_' + type(node).__name__))
```

ç°åœ¨æˆ‘ä»¬ç¨å¾®ä¿®æ”¹ä¸‹ä¸Šé¢çš„Evaluatorï¼š
```python
class Evaluator(NodeVisitor):
    def visit_Number(self, node):
        return node.value

    def visit_Add(self, node):
        yield (yield node.left) + (yield node.right)

    def visit_Sub(self, node):
        yield (yield node.left) - (yield node.right)

    def visit_Mul(self, node):
        yield (yield node.left) * (yield node.right)

    def visit_Div(self, node):
        yield (yield node.left) / (yield node.right)

    def visit_Negate(self, node):


>>> a = Number(0)
>>> for n in range(1,100000):
...     a = Add(a, Number(n))
...
>>> e = Evaluator()
>>> e.visit(a)
4999950000
>>>
```
ç”Ÿæˆå™¨å’Œåç¨‹åœ¨ç¨‹åºæ§åˆ¶æµæ–¹é¢çš„å¼ºå¤§åŠŸèƒ½ã€‚ é¿å…é€’å½’çš„ä¸€ä¸ªé€šå¸¸æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ªæ ˆæˆ–é˜Ÿåˆ—çš„æ•°æ®ç»“æ„ã€‚ ä¾‹å¦‚ï¼Œæ·±åº¦ä¼˜å…ˆçš„éå†ç®—æ³•ï¼Œç¬¬ä¸€æ¬¡ç¢°åˆ°ä¸€ä¸ªèŠ‚ç‚¹æ—¶å°†å…¶å‹å…¥æ ˆä¸­ï¼Œå¤„ç†å®Œåå¼¹å‡ºæ ˆã€‚`visit()` æ–¹æ³•çš„æ ¸å¿ƒæ€è·¯å°±æ˜¯è¿™æ ·ã€‚



### ğŸ å…ƒç¼–ç¨‹

#### ğŸ¯ è£…é¥°å™¨

ğŸ§© ä¸€ä¸ªè£…é¥°å™¨å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°å¹¶è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°ã€‚å¦‚æœæƒ³ä½¿ç”¨é¢å¤–çš„ä»£ç ï¼ˆæ¯”å¦‚æ—¥å¿—ã€è®¡æ—¶ç­‰ï¼‰åŒ…è£…ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªè£…é¥°å™¨å‡½æ•°ï¼Œä¾‹å¦‚ï¼š
```python
import time
from functools import wraps

def timethis(func):
    '''
    Decorator that reports the execution time.
    '''
    @wraps(func)
    def wrapper(*args, **kwargs):
        start = time.time()
        result = func(*args, **kwargs)
        end = time.time()
        print(func.__name__, end-start)
        return result
    return wrapper


>>> @timethis
... def countdown(n):
...     '''
...     Counts down
...     '''
...     while n > 0:
...         n -= 1
...
>>> countdown(100000)
countdown 0.008917808532714844
>>> countdown(10000000)
countdown 0.87188299392912
>>>
```

ğŸ§© åˆ›å»ºè£…é¥°å™¨æ—¶ä¿ç•™å‡½æ•°å…ƒä¿¡æ¯ã€‚åº”è¯¥ä½¿ç”¨ functools åº“ä¸­çš„ @wraps è£…é¥°å™¨æ¥æ³¨è§£åº•å±‚åŒ…è£…å‡½æ•°ã€‚ä¾‹å¦‚ï¼š
```python
import time
from functools import wraps
def timethis(func):
    '''
    Decorator that reports the execution time.
    '''
    @wraps(func)
    def wrapper(*args, **kwargs):
        start = time.time()
        result = func(*args, **kwargs)
        end = time.time()
        print(func.__name__, end-start)
        return result
    return wrapper


>>> @timethis
... def countdown(n):
...     '''
...     Counts down
...     '''
...     while n > 0:
...         n -= 1
...
>>> countdown(100000)
countdown 0.008917808532714844
>>> countdown.__name__
'countdown'
>>> countdown.__doc__
'\n\tCounts down\n\t'
>>> countdown.__annotations__
{'n': <class 'int'>}
>>>
```

ğŸ§© å½“éœ€è¦è§£é™¤ä¸€ä¸ªè£…é¥°å™¨æ—¶ã€‚å¯ä»¥é€šè¿‡è®¿é—® `__wrapped__` å±æ€§æ¥è®¿é—®åŸå§‹å‡½æ•°ï¼Œå‰ææ˜¯åœ¨åŒ…è£…å™¨ä¸­æ­£ç¡®ä½¿ç”¨äº† `@wraps` æˆ–è€…ç›´æ¥è®¾ç½®äº† `__wrapped__` å±æ€§çš„æƒ…å†µã€‚ï¼š
```python
>>> @somedecorator
>>> def add(x, y):
...     return x + y
...
>>> orig_add = add.__wrapped__
>>> orig_add(3, 4)
7
>>>
```

ğŸ§© å®šä¹‰ä¸€ä¸ªå¸¦å‚æ•°çš„è£…é¥°å™¨ã€‚å‡è®¾æƒ³å†™ä¸€ä¸ªè£…é¥°å™¨ï¼Œç»™å‡½æ•°æ·»åŠ æ—¥å¿—åŠŸèƒ½ï¼ŒåŒæ—¶å…è®¸ç”¨æˆ·æŒ‡å®šæ—¥å¿—çš„çº§åˆ«å’Œå…¶ä»–çš„é€‰é¡¹ã€‚ä¸‹é¢æ˜¯è¿™ä¸ªè£…é¥°å™¨çš„å®šä¹‰å’Œä½¿ç”¨ç¤ºä¾‹ï¼š
```python
from functools import wraps
import logging

def logged(level, name=None, message=None):
    """
    Add logging to a function. level is the logging
    level, name is the logger name, and message is the
    log message. If name and message aren't specified,
    they default to the function's module and name.
    """
    def decorate(func):
        logname = name if name else func.__module__
        log = logging.getLogger(logname)
        logmsg = message if message else func.__name__

        @wraps(func)
        def wrapper(*args, **kwargs):
            log.log(level, logmsg)
            return func(*args, **kwargs)
        return wrapper
    return decorate

# Example use
@logged(logging.DEBUG)
def add(x, y):
    return x + y

@logged(logging.CRITICAL, 'example')
def spam():
    print('Spam!')
```
åˆçœ‹èµ·æ¥ï¼Œè¿™ç§å®ç°çœ‹ä¸Šå»å¾ˆå¤æ‚ï¼Œä½†æ˜¯æ ¸å¿ƒæ€æƒ³å¾ˆç®€å•ã€‚ æœ€å¤–å±‚çš„å‡½æ•° `logged()` æ¥å—å‚æ•°å¹¶å°†å®ƒä»¬ä½œç”¨åœ¨å†…éƒ¨çš„è£…é¥°å™¨å‡½æ•°ä¸Šé¢ã€‚ å†…å±‚çš„å‡½æ•° `decorate()` æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œç„¶ååœ¨å‡½æ•°ä¸Šé¢æ”¾ç½®ä¸€ä¸ªåŒ…è£…å™¨ã€‚ è¿™é‡Œçš„å…³é”®ç‚¹æ˜¯åŒ…è£…å™¨æ˜¯å¯ä»¥ä½¿ç”¨ä¼ é€’ç»™ `logged()` çš„å‚æ•°çš„ã€‚

ğŸ§© å¯è‡ªå®šä¹‰å±æ€§çš„è£…é¥°å™¨ã€‚å†™ä¸€ä¸ªè£…é¥°å™¨æ¥åŒ…è£…ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”å…è®¸ç”¨æˆ·æä¾›å‚æ•°åœ¨è¿è¡Œæ—¶æ§åˆ¶è£…é¥°å™¨è¡Œä¸ºã€‚å¼•å…¥ä¸€ä¸ªè®¿é—®å‡½æ•°ï¼Œä½¿ç”¨ `nonlocal` æ¥ä¿®æ”¹å†…éƒ¨å˜é‡ã€‚ ç„¶åè¿™ä¸ªè®¿é—®å‡½æ•°è¢«ä½œä¸ºä¸€ä¸ªå±æ€§èµ‹å€¼ç»™åŒ…è£…å‡½æ•°ã€‚
```python
from functools import wraps, partial
import logging
# Utility decorator to attach a function as an attribute of obj
def attach_wrapper(obj, func=None):
    if func is None:
        return partial(attach_wrapper, obj)
    setattr(obj, func.__name__, func)
    return func

def logged(level, name=None, message=None):
    '''
    Add logging to a function. level is the logging
    level, name is the logger name, and message is the
    log message. If name and message aren't specified,
    they default to the function's module and name.
    '''
    def decorate(func):
        logname = name if name else func.__module__
        log = logging.getLogger(logname)
        logmsg = message if message else func.__name__

        @wraps(func)
        def wrapper(*args, **kwargs):
            log.log(level, logmsg)
            return func(*args, **kwargs)

        # Attach setter functions
        @attach_wrapper(wrapper)
        def set_level(newlevel):
            nonlocal level
            level = newlevel

        @attach_wrapper(wrapper)
        def set_message(newmsg):
            nonlocal logmsg
            logmsg = newmsg

        return wrapper

    return decorate

# Example use
@logged(logging.DEBUG)
def add(x, y):
    return x + y

@logged(logging.CRITICAL, 'example')
def spam():
    print('Spam!')


>>> import logging
>>> logging.basicConfig(level=logging.DEBUG)
>>> add(2, 3)
DEBUG:__main__:add
5
>>> # Change the log message
>>> add.set_message('Add called')
>>> add(2, 3)
DEBUG:__main__:Add called
5
>>> # Change the log level
>>> add.set_level(logging.WARNING)
>>> add(2, 3)
WARNING:__main__:Add called
5
>>>
```
å…³é”®ç‚¹åœ¨äºè®¿é—®å‡½æ•°(å¦‚ `set_message()` å’Œ `set_level()` )ï¼Œå®ƒä»¬è¢«ä½œä¸ºå±æ€§èµ‹ç»™åŒ…è£…å™¨ã€‚ æ¯ä¸ªè®¿é—®å‡½æ•°å…è®¸ä½¿ç”¨ `nonlocal`æ¥ä¿®æ”¹å‡½æ•°å†…éƒ¨çš„å˜é‡ã€‚


ğŸ§© å¸¦å¯é€‰å‚æ•°çš„è£…é¥°å™¨ã€‚ä¸€ä¸ªè£…é¥°å™¨ï¼Œæ—¢å¯ä»¥ä¸ä¼ å‚æ•°ç»™å®ƒï¼Œæ¯”å¦‚ `@decorator` ï¼Œ ä¹Ÿå¯ä»¥ä¼ é€’å¯é€‰å‚æ•°ç»™å®ƒï¼Œæ¯”å¦‚ `@decorator(x,y,z)` ã€‚
```python
def logged(func=None, *, level=logging.DEBUG, name=None, message=None):
    if func is None:
        return partial(logged, level=level, name=name, message=message)

    logname = name if name else func.__module__
    log = logging.getLogger(logname)
    logmsg = message if message else func.__name__

    @wraps(func)
    def wrapper(*args, **kwargs):
        log.log(level, logmsg)
        return func(*args, **kwargs)

    return wrapper

# Example use
@logged
def add(x, y):
    return x + y

@logged(level=logging.CRITICAL, name='example')
def spam():
    print('Spam!')

print(add(2, 3))
spam()
```
ä¸ºäº†ç†è§£ä»£ç æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œéœ€è¦éå¸¸ç†Ÿæ‚‰è£…é¥°å™¨æ˜¯å¦‚ä½•ä½œç”¨åˆ°å‡½æ•°ä¸Šä»¥åŠå®ƒä»¬çš„è°ƒç”¨è§„åˆ™ã€‚ å¯¹äºä¸€ä¸ªåƒä¸‹é¢è¿™æ ·çš„ç®€å•è£…é¥°å™¨ï¼š
```python
# Example use
@logged
def add(x, y):
    return x + y
```

è¿™ä¸ªè°ƒç”¨åºåˆ—è·Ÿä¸‹é¢ç­‰ä»·ï¼š
```python
def add(x, y):
    return x + y

add = logged(add)
```

è¿™æ—¶å€™ï¼Œè¢«è£…é¥°å‡½æ•°ä¼šè¢«å½“åšç¬¬ä¸€ä¸ªå‚æ•°ç›´æ¥ä¼ é€’ç»™ `logged` è£…é¥°å™¨ã€‚ å› æ­¤ï¼Œ`logged()` ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯è¢«åŒ…è£…å‡½æ•°æœ¬èº«ã€‚æ‰€æœ‰å…¶ä»–å‚æ•°éƒ½å¿…é¡»æœ‰é»˜è®¤å€¼ã€‚

è€Œå¯¹äºä¸€ä¸ªä¸‹é¢è¿™æ ·æœ‰å‚æ•°çš„è£…é¥°å™¨ï¼š
```python
@logged(level=logging.CRITICAL, name='example')
def spam():
    print('Spam!')
```

è°ƒç”¨åºåˆ—è·Ÿä¸‹é¢ç­‰ä»·ï¼š
```python
def spam():
    print('Spam!')
spam = logged(level=logging.CRITICAL, name='example')(spam)
```

åˆå§‹è°ƒç”¨` logged()` å‡½æ•°æ—¶ï¼Œè¢«åŒ…è£…å‡½æ•°å¹¶æ²¡æœ‰ä¼ é€’è¿›æ¥ã€‚ å› æ­¤åœ¨è£…é¥°å™¨å†…ï¼Œå®ƒå¿…é¡»æ˜¯å¯é€‰çš„ã€‚è¿™ä¸ªåè¿‡æ¥ä¼šè¿«ä½¿å…¶ä»–å‚æ•°å¿…é¡»ä½¿ç”¨å…³é”®å­—æ¥æŒ‡å®šã€‚ å¹¶ä¸”ï¼Œå½“è¿™äº›å‚æ•°è¢«ä¼ é€’è¿›æ¥åï¼Œè£…é¥°å™¨è¦è¿”å›ä¸€ä¸ªæ¥å—ä¸€ä¸ªå‡½æ•°å‚æ•°å¹¶åŒ…è£…å®ƒçš„å‡½æ•°ã€‚ ä¸ºäº†è¿™æ ·åšï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªæŠ€å·§ï¼Œå°±æ˜¯åˆ©ç”¨ `functools.partial` ã€‚ å®ƒä¼šè¿”å›ä¸€ä¸ªæœªå®Œå…¨åˆå§‹åŒ–çš„è‡ªèº«ï¼Œé™¤äº†è¢«åŒ…è£…å‡½æ•°å¤–å…¶ä»–å‚æ•°éƒ½å·²ç»ç¡®å®šä¸‹æ¥äº†ã€‚


#### ğŸ¯ åˆ©ç”¨è£…é¥°å™¨å¼ºåˆ¶å‡½æ•°ä¸Šçš„ç±»å‹æ£€æŸ¥
ä½œä¸ºæŸç§ç¼–ç¨‹è§„çº¦ï¼Œæƒ³åœ¨å¯¹å‡½æ•°å‚æ•°è¿›è¡Œå¼ºåˆ¶ç±»å‹æ£€æŸ¥ã€‚ä¸‹é¢æ˜¯ä½¿ç”¨è£…é¥°å™¨æŠ€æœ¯æ¥å®ç° `@typeassert` ï¼š
```python
from inspect import signature
from functools import wraps

def typeassert(*ty_args, **ty_kwargs):
    def decorate(func):
        # If in optimized mode, disable type checking
        if not __debug__:
            return func

        # Map function argument names to supplied types
        sig = signature(func)
        bound_types = sig.bind_partial(*ty_args, **ty_kwargs).arguments

        @wraps(func)
        def wrapper(*args, **kwargs):
            bound_values = sig.bind(*args, **kwargs)
            # Enforce type assertions across supplied arguments
            for name, value in bound_values.arguments.items():
                if name in bound_types:
                    if not isinstance(value, bound_types[name]):
                        raise TypeError(
                            'Argument {} must be {}'.format(name, bound_types[name])
                            )
            return func(*args, **kwargs)
        return wrapper
    return decorate


>>> @typeassert(int, int)
... def add(x, y):
...     return x + y
...
>>>
>>> add(2, 3)
5
>>> add(2, 'hello')
Traceback (most recent call last):
    File "<stdin>", line 1, in <module>
    File "contract.py", line 33, in wrapper
TypeError: Argument y must be <class 'int'>
>>>

# å¯ä»¥çœ‹å‡ºè¿™ä¸ªè£…é¥°å™¨éå¸¸çµæ´»ï¼Œæ—¢å¯ä»¥æŒ‡å®šæ‰€æœ‰å‚æ•°ç±»å‹ï¼Œä¹Ÿå¯ä»¥åªæŒ‡å®šéƒ¨åˆ†ã€‚ å¹¶ä¸”å¯ä»¥é€šè¿‡ä½ç½®æˆ–å…³é”®å­—æ¥æŒ‡å®šå‚æ•°ç±»å‹ã€‚
>>> @typeassert(int, z=int)
... def spam(x, y, z=42):
...     print(x, y, z)
...
>>> spam(1, 2, 3)
1 2 3
>>> spam(1, 'hello', 3)
1 hello 3
>>> spam(1, 'hello', 'world')
Traceback (most recent call last):
File "<stdin>", line 1, in <module>
File "contract.py", line 33, in wrapper
TypeError: Argument z must be <class 'int'>
>>>
```


#### ğŸ¯ å°†è£…é¥°å™¨å®šä¹‰ä¸ºç±»çš„ä¸€éƒ¨åˆ†

æƒ³åœ¨ç±»ä¸­å®šä¹‰è£…é¥°å™¨ï¼Œå¹¶å°†å…¶ä½œç”¨åœ¨å…¶ä»–å‡½æ•°æˆ–æ–¹æ³•ä¸Šã€‚åœ¨ç±»é‡Œé¢å®šä¹‰è£…é¥°å™¨å¾ˆç®€å•ï¼Œä½†æ˜¯é¦–å…ˆè¦ç¡®è®¤å®ƒçš„ä½¿ç”¨æ–¹å¼ã€‚æ¯”å¦‚åˆ°åº•æ˜¯ä½œä¸ºä¸€ä¸ªå®ä¾‹æ–¹æ³•è¿˜æ˜¯ç±»æ–¹æ³•ã€‚ ä¸‹é¢æˆ‘ä»¬ç”¨ä¾‹å­æ¥é˜è¿°å®ƒä»¬çš„ä¸åŒï¼š
```python
from functools import wraps

class A:
    # Decorator as an instance method
    def decorator1(self, func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            print('Decorator 1')
            return func(*args, **kwargs)
        return wrapper

    # Decorator as a class method
    @classmethod
    def decorator2(cls, func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            print('Decorator 2')
            return func(*args, **kwargs)
        return wrapper


# ä»”ç»†è§‚å¯Ÿå¯ä»¥å‘ç°ä¸€ä¸ªæ˜¯å®ä¾‹è°ƒç”¨ï¼Œä¸€ä¸ªæ˜¯ç±»è°ƒç”¨ã€‚
# As an instance method
a = A()
@a.decorator1
def spam():
    pass
# As a class method
@A.decorator2
def grok():
    pass
```

#### ğŸ¯ å°†è£…é¥°å™¨å®šä¹‰ä¸ºç±»
æƒ³ä½¿ç”¨ä¸€ä¸ªè£…é¥°å™¨å»åŒ…è£…å‡½æ•°ï¼Œä½†æ˜¯å¸Œæœ›è¿”å›ä¸€ä¸ªå¯è°ƒç”¨çš„å®ä¾‹ã€‚ éœ€è¦è®©è£…é¥°å™¨å¯ä»¥åŒæ—¶å·¥ä½œåœ¨ç±»å®šä¹‰çš„å†…éƒ¨å’Œå¤–éƒ¨ã€‚

ä¸ºäº†å°†è£…é¥°å™¨å®šä¹‰æˆä¸€ä¸ªå®ä¾‹ï¼Œéœ€è¦ç¡®ä¿å®ƒå®ç°äº† `__call__()` å’Œ `__get__()` æ–¹æ³•ã€‚ ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä»£ç å®šä¹‰äº†ä¸€ä¸ªç±»ï¼Œå®ƒåœ¨å…¶ä»–å‡½æ•°ä¸Šæ”¾ç½®ä¸€ä¸ªç®€å•çš„è®°å½•å±‚ï¼š
```python
import types
from functools import wraps

class Profiled:
    def __init__(self, func):
        wraps(func)(self)
        self.ncalls = 0

    def __call__(self, *args, **kwargs):
        self.ncalls += 1
        return self.__wrapped__(*args, **kwargs)

    def __get__(self, instance, cls):
        if instance is None:
            return self
        else:
            return types.MethodType(self, instance)
```

å¯ä»¥å°†å®ƒå½“åšä¸€ä¸ªæ™®é€šçš„è£…é¥°å™¨æ¥ä½¿ç”¨ï¼Œåœ¨ç±»é‡Œé¢æˆ–å¤–é¢éƒ½å¯ä»¥ï¼š
```python
@Profiled
def add(x, y):
    return x + y

class Spam:
    @Profiled
    def bar(self, x):
        print(self, x)


>>> add(2, 3)
5
>>> add(4, 5)
9
>>> add.ncalls
2
>>> s = Spam()
>>> s.bar(1)
<__main__.Spam object at 0x10069e9d0> 1
>>> s.bar(2)
<__main__.Spam object at 0x10069e9d0> 2
>>> s.bar(3)
<__main__.Spam object at 0x10069e9d0> 3
>>> Spam.bar.ncalls
3
```
`__get__()` æ–¹æ³•æ˜¯ä¸ºäº†ç¡®ä¿ç»‘å®šæ–¹æ³•å¯¹è±¡èƒ½è¢«æ­£ç¡®çš„åˆ›å»ºã€‚ `type.MethodType()` æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªç»‘å®šæ–¹æ³•æ¥ä½¿ç”¨ã€‚åªæœ‰å½“å®ä¾‹è¢«ä½¿ç”¨çš„æ—¶å€™ç»‘å®šæ–¹æ³•æ‰ä¼šè¢«åˆ›å»ºã€‚ å¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯åœ¨ç±»ä¸Šé¢æ¥è®¿é—®ï¼Œ é‚£ä¹ˆ `__get__()` ä¸­çš„ instance å‚æ•°ä¼šè¢«è®¾ç½®æˆ None å¹¶ç›´æ¥è¿”å› Profiled å®ä¾‹æœ¬èº«ã€‚ è¿™æ ·çš„è¯æˆ‘ä»¬å°±å¯ä»¥æå–å®ƒçš„ ncalls å±æ€§äº†ã€‚

å¦‚æœæƒ³é¿å…ä¸€äº›æ··ä¹±ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘å¦å¤–ä¸€ä¸ªä½¿ç”¨é—­åŒ…å’Œ nonlocal å˜é‡å®ç°çš„è£…é¥°å™¨ã€‚ä¾‹å¦‚ï¼š
```python
import types
from functools import wraps

def profiled(func):
    ncalls = 0
    @wraps(func)
    def wrapper(*args, **kwargs):
        nonlocal ncalls
        ncalls += 1
        return func(*args, **kwargs)
    wrapper.ncalls = lambda: ncalls
    return wrapper

# Example
@profiled
def add(x, y):
    return x + y
```

#### ğŸ¯ ä¸ºç±»æ–¹æ³•å’Œé™æ€æ–¹æ³•æä¾›è£…é¥°å™¨
ç»™ç±»æ–¹æ³•æˆ–é™æ€æ–¹æ³•æä¾›è£…é¥°å™¨æ˜¯å¾ˆç®€å•çš„ï¼Œä¸è¿‡è¦ç¡®ä¿è£…é¥°å™¨åœ¨ `@classmethod` æˆ– `@staticmethod` ä¹‹å‰ã€‚ä¾‹å¦‚ï¼š
```python
import time
from functools import wraps

# A simple decorator
def timethis(func):
    @wraps(func)
    def wrapper(*args, **kwargs):
        start = time.time()
        r = func(*args, **kwargs)
        end = time.time()
        print(end-start)
        return r
    return wrapper

# Class illustrating application of the decorator to different kinds of methods
class Spam:
    @timethis
    def instance_method(self, n):
        print(self, n)
        while n > 0:
            n -= 1

    @classmethod
    @timethis
    def class_method(cls, n):
        print(cls, n)
        while n > 0:
            n -= 1

    @staticmethod
    @timethis
    def static_method(n):
        print(n)
        while n > 0:
            n -= 1
```

#### ğŸ¯ è£…é¥°å™¨ä¸ºè¢«åŒ…è£…å‡½æ•°å¢åŠ å‚æ•°
åœ¨è£…é¥°å™¨ä¸­ç»™è¢«åŒ…è£…å‡½æ•°å¢åŠ é¢å¤–çš„å‚æ•°ï¼Œä½†æ˜¯ä¸èƒ½å½±å“è¿™ä¸ªå‡½æ•°ç°æœ‰çš„è°ƒç”¨è§„åˆ™ã€‚å¯ä»¥ä½¿ç”¨å…³é”®å­—å‚æ•°æ¥ç»™è¢«åŒ…è£…å‡½æ•°å¢åŠ é¢å¤–å‚æ•°ã€‚è€ƒè™‘ä¸‹é¢çš„è£…é¥°å™¨ï¼š
```python
from functools import wraps

def optional_debug(func):
    @wraps(func)
    def wrapper(*args, debug=False, **kwargs):
        if debug:
            print('Calling', func.__name__)
        return func(*args, **kwargs)

    return wrapper


>>> @optional_debug
... def spam(a,b,c):
...     print(a,b,c)
...
>>> spam(1,2,3)
1 2 3
>>> spam(1,2,3, debug=True)
Calling spam
1 2 3
>>>
```

é€šè¿‡è£…é¥°å™¨æ¥ç»™è¢«åŒ…è£…å‡½æ•°å¢åŠ å‚æ•°çš„åšæ³•å¹¶ä¸å¸¸è§ã€‚ å°½ç®¡å¦‚æ­¤ï¼Œæœ‰æ—¶å€™å®ƒå¯ä»¥é¿å…ä¸€äº›é‡å¤ä»£ç ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæœ‰ä¸‹é¢è¿™æ ·çš„ä»£ç ï¼š
```python
def a(x, debug=False):
    if debug:
        print('Calling a')

def b(x, y, z, debug=False):
    if debug:
        print('Calling b')

def c(x, y, debug=False):
    if debug:
        print('Calling c')
        
# é‡æ„
from functools import wraps
import inspect

def optional_debug(func):
    if 'debug' in inspect.getargspec(func).args:
        raise TypeError('debug argument already defined')

    @wraps(func)
    def wrapper(*args, debug=False, **kwargs):
        if debug:
            print('Calling', func.__name__)
        return func(*args, **kwargs)
    return wrapper

@optional_debug
def a(x):
    pass

@optional_debug
def b(x, y, z):
    pass

@optional_debug
def c(x, y):
    pass
```

è¿™ç§å®ç°æ–¹æ¡ˆä¹‹æ‰€ä»¥è¡Œå¾—é€šï¼Œåœ¨äºå¼ºåˆ¶å…³é”®å­—å‚æ•°å¾ˆå®¹æ˜“è¢«æ·»åŠ åˆ°æ¥å— `*args` å’Œ `**kwargs` å‚æ•°çš„å‡½æ•°ä¸­ã€‚ é€šè¿‡ä½¿ç”¨å¼ºåˆ¶å…³é”®å­—å‚æ•°ï¼Œå®ƒè¢«ä½œä¸ºä¸€ä¸ªç‰¹æ®Šæƒ…å†µè¢«æŒ‘é€‰å‡ºæ¥ï¼Œ å¹¶ä¸”æ¥ä¸‹æ¥ä»…ä»…ä½¿ç”¨å‰©ä½™çš„ä½ç½®å’Œå…³é”®å­—å‚æ•°å»è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œè¿™ä¸ªç‰¹æ®Šå‚æ•°ä¼šè¢«æ’é™¤åœ¨å¤–ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå¹¶ä¸ä¼šè¢«çº³å…¥åˆ° `**kwargs` ä¸­å»ã€‚

è¿˜æœ‰ä¸€ä¸ªéš¾ç‚¹å°±æ˜¯å¦‚ä½•å»å¤„ç†è¢«æ·»åŠ çš„å‚æ•°ä¸è¢«åŒ…è£…å‡½æ•°å‚æ•°ç›´æ¥çš„åå­—å†²çªã€‚ ä¾‹å¦‚ï¼Œå¦‚æœè£…é¥°å™¨ `@optional_debug` ä½œç”¨åœ¨ä¸€ä¸ªå·²ç»æ‹¥æœ‰ä¸€ä¸ª `debug` å‚æ•°çš„å‡½æ•°ä¸Šæ—¶ä¼šæœ‰é—®é¢˜ã€‚ è¿™é‡Œæˆ‘ä»¬å¢åŠ äº†ä¸€æ­¥åå­—æ£€æŸ¥ã€‚

âš ï¸æœ€åå…³äºè¢«åŒ…è£…å‡½æ•°çš„å‡½æ•°ç­¾åå¦‚ä½•é‡æ–°ç»‘å®šä¸ºæ­£ç¡®çš„ï¼Œå‚è€ƒå†…ç½®çš„ `inspect` æ¨¡å—ã€‚


#### ğŸ¯ ä½¿ç”¨è£…é¥°å™¨æ‰©å……ç±»çš„åŠŸèƒ½
é€šè¿‡åçœæˆ–è€…é‡å†™ç±»å®šä¹‰çš„æŸéƒ¨åˆ†æ¥ä¿®æ”¹å®ƒçš„è¡Œä¸ºï¼Œä½†æ˜¯åˆä¸å¸Œæœ›ä½¿ç”¨ç»§æ‰¿æˆ–å…ƒç±»çš„æ–¹å¼ã€‚è¿™ç§æƒ…å†µå¯èƒ½æ˜¯ç±»è£…é¥°å™¨æœ€å¥½çš„ä½¿ç”¨åœºæ™¯äº†ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªé‡å†™äº†ç‰¹æ®Šæ–¹æ³• `__getattribute__` çš„ç±»è£…é¥°å™¨ï¼Œ å¯ä»¥æ‰“å°æ—¥å¿—ï¼š
```python
def log_getattribute(cls):
    # Get the original implementation
    orig_getattribute = cls.__getattribute__

    # Make a new definition
    def new_getattribute(self, name):
        print('getting:', name)
        return orig_getattribute(self, name)

    # Attach to the class and return
    cls.__getattribute__ = new_getattribute
    return cls

# Example use
@log_getattribute
class A:
    def __init__(self,x):
        self.x = x
    def spam(self):
        pass


>>> a = A(42)
>>> a.x
getting: x
42
>>> a.spam()
getting: spam
>>>
```

ç±»è£…é¥°å™¨é€šå¸¸å¯ä»¥ä½œä¸ºå…¶ä»–é«˜çº§æŠ€æœ¯æ¯”å¦‚æ··å…¥æˆ–å…ƒç±»çš„ä¸€ç§éå¸¸ç®€æ´çš„æ›¿ä»£æ–¹æ¡ˆã€‚ æ¯”å¦‚ï¼Œä¸Šé¢ç¤ºä¾‹ä¸­çš„å¦å¤–ä¸€ç§å®ç°ä½¿ç”¨åˆ°ç»§æ‰¿ï¼š
```python
class LoggedGetattribute:
    def __getattribute__(self, name):
        print('getting:', name)
        return super().__getattribute__(name)

# Example:
class A(LoggedGetattribute):
    def __init__(self,x):
        self.x = x
    def spam(self):
        pass
```
è¿™ç§æ–¹æ¡ˆä¹Ÿè¡Œå¾—é€šï¼Œä½†æ˜¯ä¸ºäº†å»ç†è§£å®ƒï¼Œå°±å¿…é¡»çŸ¥é“æ–¹æ³•è°ƒç”¨é¡ºåºã€`super()` ä»¥åŠå…¶å®ƒ8.7å°èŠ‚ä»‹ç»çš„ç»§æ‰¿çŸ¥è¯†ã€‚ æŸç§ç¨‹åº¦ä¸Šæ¥è®²ï¼Œç±»è£…é¥°å™¨æ–¹æ¡ˆå°±æ˜¾å¾—æ›´åŠ ç›´è§‚ï¼Œå¹¶ä¸”å®ƒä¸ä¼šå¼•å…¥æ–°çš„ç»§æ‰¿ä½“ç³»ã€‚å®ƒçš„è¿è¡Œé€Ÿåº¦ä¹Ÿæ›´å¿«ä¸€äº›ï¼Œ å› ä¸ºä»–å¹¶ä¸ä¾èµ– `super()` å‡½æ•°ã€‚


#### ğŸ¯ ä½¿ç”¨å…ƒç±»æ§åˆ¶å®ä¾‹çš„åˆ›å»º

é€šè¿‡æ”¹å˜å®ä¾‹åˆ›å»ºæ–¹å¼æ¥å®ç°å•ä¾‹ã€ç¼“å­˜æˆ–å…¶ä»–ç±»ä¼¼çš„ç‰¹æ€§ã€‚åˆ©ç”¨å…ƒç±»å®ç°å¤šç§å®ä¾‹åˆ›å»ºæ¨¡å¼é€šå¸¸è¦æ¯”ä¸ä½¿ç”¨å…ƒç±»çš„æ–¹å¼ä¼˜é›…å¾—å¤šã€‚

Pythonç¨‹åºå‘˜éƒ½çŸ¥é“ï¼Œå¦‚æœå®šä¹‰äº†ä¸€ä¸ªç±»ï¼Œå°±èƒ½åƒå‡½æ•°ä¸€æ ·çš„è°ƒç”¨å®ƒæ¥åˆ›å»ºå®ä¾‹ï¼Œä¾‹å¦‚ï¼š
```python
class Spam:
    def __init__(self, name):
        self.name = name

a = Spam('Guido')
b = Spam('Diana')
```

å¦‚æœæƒ³è‡ªå®šä¹‰è¿™ä¸ªæ­¥éª¤ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªå…ƒç±»å¹¶è‡ªå·±å®ç° `__call__()` æ–¹æ³•ã€‚

ä¸ºäº†æ¼”ç¤ºï¼Œå‡è®¾ä¸æƒ³ä»»ä½•äººåˆ›å»ºè¿™ä¸ªç±»çš„å®ä¾‹ï¼š
```python
class NoInstances(type):
    def __call__(self, *args, **kwargs):
        raise TypeError("Can't instantiate directly")

# Example
class Spam(metaclass=NoInstances):
    @staticmethod
    def grok(x):
        print('Spam.grok')


# è¿™æ ·çš„è¯ï¼Œç”¨æˆ·åªèƒ½è°ƒç”¨è¿™ä¸ªç±»çš„é™æ€æ–¹æ³•ï¼Œè€Œä¸èƒ½ä½¿ç”¨é€šå¸¸çš„æ–¹æ³•æ¥åˆ›å»ºå®ƒçš„å®ä¾‹ã€‚ä¾‹å¦‚ï¼š
>>> Spam.grok(42)
Spam.grok
>>> s = Spam()
Traceback (most recent call last):
    File "<stdin>", line 1, in <module>
    File "example1.py", line 7, in __call__
        raise TypeError("Can't instantiate directly")
TypeError: Can't instantiate directly
>>>
```

ğŸ§© å®ç°å•ä¾‹æ¨¡å¼ï¼ˆåªèƒ½åˆ›å»ºå”¯ä¸€å®ä¾‹çš„ç±»ï¼‰ï¼Œå®ç°èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼š
```python
class Singleton(type):
    def __init__(self, *args, **kwargs):
        self.__instance = None
        super().__init__(*args, **kwargs)

    def __call__(self, *args, **kwargs):
        if self.__instance is None:
            self.__instance = super().__call__(*args, **kwargs)
            return self.__instance
        else:
            return self.__instance

# Example
class Spam(metaclass=Singleton):
    def __init__(self):
        print('Creating Spam')


# Usage
>>> a = Spam()
Creating Spam
>>> b = Spam()
>>> a is b
True
>>> c = Spam()
>>> a is c
True
>>>
```

ğŸ§© å®ç°ç¼“å­˜å®ä¾‹ã€‚ä¸‹é¢æˆ‘ä»¬å¯ä»¥é€šè¿‡å…ƒç±»æ¥å®ç°ï¼š
```python
import weakref

class Cached(type):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.__cache = weakref.WeakValueDictionary()

    def __call__(self, *args):
        if args in self.__cache:
            return self.__cache[args]
        else:
            obj = super().__call__(*args)
            self.__cache[args] = obj
            return obj

# Example
class Spam(metaclass=Cached):
    def __init__(self, name):
        print('Creating Spam({!r})'.format(name))
        self.name = name

# Usage
>>> a = Spam('Guido')
Creating Spam('Guido')
>>> b = Spam('Diana')
Creating Spam('Diana')
>>> c = Spam('Guido') # Cached
>>> a is b
False
>>> a is c # Cached value returned
True
>>>
```


#### ğŸ¯ ä½¿ç”¨å…ƒç±»åœ¨ç±»ä¸Šå¼ºåˆ¶ä½¿ç”¨ç¼–ç¨‹è§„çº¦

ç¨‹åºåŒ…å«ä¸€ä¸ªå¾ˆå¤§çš„ç±»ç»§æ‰¿ä½“ç³»ï¼Œå¸Œæœ›å¼ºåˆ¶æ‰§è¡ŒæŸäº›ç¼–ç¨‹è§„çº¦ï¼ˆæˆ–è€…ä»£ç è¯Šæ–­ï¼‰æ¥å¸®åŠ©ç¨‹åºå‘˜ä¿æŒæ¸…é†’ã€‚

å¦‚æœæƒ³ç›‘æ§ç±»çš„å®šä¹‰ï¼Œé€šå¸¸å¯ä»¥é€šè¿‡å®šä¹‰ä¸€ä¸ªå…ƒç±»ã€‚ä¸€ä¸ªåŸºæœ¬å…ƒç±»é€šå¸¸æ˜¯ç»§æ‰¿è‡ª type å¹¶é‡å®šä¹‰å®ƒçš„ `__new__()` æ–¹æ³• æˆ–è€…æ˜¯ `__init__()` æ–¹æ³•ã€‚æ¯”å¦‚ï¼š
```python
class MyMeta(type):
    def __new__(self, clsname, bases, clsdict):
        # clsname is name of class being defined
        # bases is tuple of base classes
        # clsdict is class dictionary
        return super().__new__(cls, clsname, bases, clsdict)

class MyMeta(type):
    def __init__(self, clsname, bases, clsdict):
        super().__init__(clsname, bases, clsdict)
        # clsname is name of class being defined
        # bases is tuple of base classes
        # clsdict is class dictionary
```

ä¸ºäº†ä½¿ç”¨è¿™ä¸ªå…ƒç±»ï¼Œé€šå¸¸è¦å°†å®ƒæ”¾åˆ°åˆ°ä¸€ä¸ªé¡¶çº§çˆ¶ç±»å®šä¹‰ä¸­ï¼Œç„¶åå…¶ä»–çš„ç±»ç»§æ‰¿è¿™ä¸ªé¡¶çº§çˆ¶ç±»ã€‚ä¾‹å¦‚ï¼š
```python
class Root(metaclass=MyMeta):
    pass

class A(Root):
    pass

class B(Root):
    pass
```

å…ƒç±»çš„ä¸€ä¸ªå…³é”®ç‰¹ç‚¹æ˜¯å®ƒå…è®¸åœ¨å®šä¹‰çš„æ—¶å€™æ£€æŸ¥ç±»çš„å†…å®¹ã€‚åœ¨é‡æ–°å®šä¹‰ `__init__()` æ–¹æ³•ä¸­ï¼Œ å¯ä»¥å¾ˆè½»æ¾çš„æ£€æŸ¥ç±»å­—å…¸ã€çˆ¶ç±»ç­‰ç­‰ã€‚å¹¶ä¸”ï¼Œä¸€æ—¦æŸä¸ªå…ƒç±»è¢«æŒ‡å®šç»™äº†æŸä¸ªç±»ï¼Œé‚£ä¹ˆå°±ä¼šè¢«ç»§æ‰¿åˆ°æ‰€æœ‰å­ç±»ä¸­å»ã€‚ å› æ­¤ï¼Œä¸€ä¸ªæ¡†æ¶çš„æ„å»ºè€…å°±èƒ½åœ¨å¤§å‹çš„ç»§æ‰¿ä½“ç³»ä¸­é€šè¿‡ç»™ä¸€ä¸ªé¡¶çº§çˆ¶ç±»æŒ‡å®šä¸€ä¸ªå…ƒç±»å»æ•è·æ‰€æœ‰ä¸‹é¢å­ç±»çš„å®šä¹‰ã€‚

ä½œä¸ºä¸€ä¸ªå…·ä½“çš„åº”ç”¨ä¾‹å­ï¼Œä¸‹é¢å®šä¹‰äº†ä¸€ä¸ªå…ƒç±»ï¼Œå®ƒä¼šæ‹’ç»ä»»ä½•æœ‰æ··åˆå¤§å°å†™åå­—ä½œä¸ºæ–¹æ³•çš„ç±»å®šä¹‰ï¼š
```python
class NoMixedCaseMeta(type):
    def __new__(cls, clsname, bases, clsdict):
        for name in clsdict:
            if name.lower() != name:
                raise TypeError('Bad attribute name: ' + name)
        return super().__new__(cls, clsname, bases, clsdict)

class Root(metaclass=NoMixedCaseMeta):
    pass

class A(Root):
    def foo_bar(self): # Ok
        pass

class B(Root):
    def fooBar(self): # TypeError
        pass
```

ä½œä¸ºæ›´é«˜çº§å’Œå®ç”¨çš„ä¾‹å­ï¼Œä¸‹é¢æœ‰ä¸€ä¸ªå…ƒç±»ï¼Œå®ƒç”¨æ¥æ£€æµ‹é‡è½½æ–¹æ³•ï¼Œç¡®ä¿å®ƒçš„è°ƒç”¨å‚æ•°è·Ÿçˆ¶ç±»ä¸­åŸå§‹æ–¹æ³•æœ‰ç€ç›¸åŒçš„å‚æ•°ç­¾åã€‚
```python
from inspect import signature
import logging

class MatchSignaturesMeta(type):

    def __init__(self, clsname, bases, clsdict):
        super().__init__(clsname, bases, clsdict)
        sup = super(self, self)
        for name, value in clsdict.items():
            if name.startswith('_') or not callable(value):
                continue
            # Get the previous definition (if any) and compare the signatures
            prev_dfn = getattr(sup,name,None)
            if prev_dfn:
                prev_sig = signature(prev_dfn)
                val_sig = signature(value)
                if prev_sig != val_sig:
                    logging.warning('Signature mismatch in %s. %s != %s',
                                    value.__qualname__, prev_sig, val_sig)

# Example
class Root(metaclass=MatchSignaturesMeta):
    pass

class A(Root):
    def foo(self, x, y):
        pass

    def spam(self, x, *, z):
        pass

# Class with redefined methods, but slightly different signatures
class B(A):
    def foo(self, a, b):
        pass

    def spam(self,x,z):
        pass
```

å¦‚æœè¿è¡Œè¿™æ®µä»£ç ï¼Œå°±ä¼šå¾—åˆ°ä¸‹é¢è¿™æ ·çš„è¾“å‡ºç»“æœï¼š
```python
WARNING:root:Signature mismatch in B.spam. (self, x, *, z) != (self, x, z)
WARNING:root:Signature mismatch in B.foo. (self, x, y) != (self, a, b)
```

è¿™ç§è­¦å‘Šä¿¡æ¯å¯¹äºæ•è·ä¸€äº›å¾®å¦™çš„ç¨‹åºbugæ˜¯å¾ˆæœ‰ç”¨çš„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæŸä¸ªä»£ç ä¾èµ–äºä¼ é€’ç»™æ–¹æ³•çš„å…³é”®å­—å‚æ•°ï¼Œ é‚£ä¹ˆå½“å­ç±»æ”¹å˜å‚æ•°åå­—çš„æ—¶å€™å°±ä¼šè°ƒç”¨å‡ºé”™ã€‚

åœ¨å¤§å‹é¢å‘å¯¹è±¡çš„ç¨‹åºä¸­ï¼Œé€šå¸¸å°†ç±»çš„å®šä¹‰æ”¾åœ¨å…ƒç±»ä¸­æ§åˆ¶æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚ å…ƒç±»å¯ä»¥ç›‘æ§ç±»çš„å®šä¹‰ï¼Œè­¦å‘Šç¼–ç¨‹äººå‘˜æŸäº›æ²¡æœ‰æ³¨æ„åˆ°çš„å¯èƒ½å‡ºç°çš„é—®é¢˜ã€‚

æœ‰äººå¯èƒ½ä¼šè¯´ï¼Œåƒè¿™æ ·çš„é”™è¯¯å¯ä»¥é€šè¿‡ç¨‹åºåˆ†æå·¥å…·æˆ–IDEå»åšä¼šæ›´å¥½äº›ã€‚è¯šç„¶ï¼Œè¿™äº›å·¥å…·æ˜¯å¾ˆæœ‰ç”¨ã€‚ ä½†æ˜¯ï¼Œå¦‚æœåœ¨æ„å»ºä¸€ä¸ªæ¡†æ¶æˆ–å‡½æ•°åº“ä¾›å…¶ä»–äººä½¿ç”¨ï¼Œé‚£ä¹ˆæ²¡åŠæ³•å»æ§åˆ¶ä½¿ç”¨è€…è¦ä½¿ç”¨ä»€ä¹ˆå·¥å…·ã€‚ å› æ­¤ï¼Œå¯¹äºè¿™ç§ç±»å‹çš„ç¨‹åºï¼Œå¦‚æœå¯ä»¥åœ¨å…ƒç±»ä¸­åšæ£€æµ‹æˆ–è®¸å¯ä»¥å¸¦æ¥æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

åœ¨å…ƒç±»ä¸­é€‰æ‹©é‡æ–°å®šä¹‰ `__new__()` æ–¹æ³•è¿˜æ˜¯ `__init__()` æ–¹æ³•å–å†³äºæƒ³æ€æ ·ä½¿ç”¨ç»“æœç±»ã€‚ `__new__()` æ–¹æ³•åœ¨ç±»åˆ›å»ºä¹‹å‰è¢«è°ƒç”¨ï¼Œé€šå¸¸ç”¨äºé€šè¿‡æŸç§æ–¹å¼ï¼ˆæ¯”å¦‚é€šè¿‡æ”¹å˜ç±»å­—å…¸çš„å†…å®¹ï¼‰ä¿®æ”¹ç±»çš„å®šä¹‰ã€‚ è€Œ `__init__()` æ–¹æ³•æ˜¯åœ¨ç±»è¢«åˆ›å»ºä¹‹åè¢«è°ƒç”¨ï¼Œå½“éœ€è¦å®Œæ•´æ„å»ºç±»å¯¹è±¡çš„æ—¶å€™ä¼šå¾ˆæœ‰ç”¨ã€‚ åœ¨æœ€åä¸€ä¸ªä¾‹å­ä¸­ï¼Œè¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå®ƒä½¿ç”¨äº† `super()` å‡½æ•°æ¥æœç´¢ä¹‹å‰çš„å®šä¹‰ã€‚ å®ƒåªèƒ½åœ¨ç±»çš„å®ä¾‹è¢«åˆ›å»ºä¹‹åï¼Œå¹¶ä¸”ç›¸åº”çš„æ–¹æ³•è§£æé¡ºåºä¹Ÿå·²ç»è¢«è®¾ç½®å¥½äº†ã€‚

æœ€åä¸€ä¸ªä¾‹å­è¿˜æ¼”ç¤ºäº†Pythonçš„å‡½æ•°ç­¾åå¯¹è±¡çš„ä½¿ç”¨ã€‚ å®é™…ä¸Šï¼Œå…ƒç±»å°†æ¯ä¸ªå¯è°ƒç”¨å®šä¹‰æ”¾åœ¨ä¸€ä¸ªç±»ä¸­ï¼Œæœç´¢å‰ä¸€ä¸ªå®šä¹‰ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œ ç„¶åé€šè¿‡ä½¿ç”¨ `inspect.signature()` æ¥ç®€å•çš„æ¯”è¾ƒå®ƒä»¬çš„è°ƒç”¨ç­¾åã€‚

æœ€åä¸€ç‚¹ï¼Œä»£ç ä¸­æœ‰ä¸€è¡Œä½¿ç”¨äº† `super(self, self)` å¹¶ä¸æ˜¯æ’ç‰ˆé”™è¯¯ã€‚ å½“ä½¿ç”¨å…ƒç±»çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦æ—¶åˆ»è®°ä½ä¸€ç‚¹å°±æ˜¯ `self` å®é™…ä¸Šæ˜¯ä¸€ä¸ªç±»å¯¹è±¡ã€‚ å› æ­¤ï¼Œè¿™æ¡è¯­å¥å…¶å®å°±æ˜¯ç”¨æ¥å¯»æ‰¾ä½äºç»§æ‰¿ä½“ç³»ä¸­æ„å»º `self` çˆ¶ç±»çš„å®šä¹‰ã€‚


#### ğŸ¯ åœ¨ç±»å®šä¹‰çš„æ—¶å€™åˆå§‹åŒ–ç±»çš„æˆå‘˜
åœ¨ç±»è¢«å®šä¹‰çš„æ—¶å€™å°±åˆå§‹åŒ–ä¸€éƒ¨åˆ†ç±»çš„æˆå‘˜ï¼Œè€Œä¸æ˜¯è¦ç­‰åˆ°å®ä¾‹è¢«åˆ›å»ºåï¼Œåœ¨ç±»å®šä¹‰æ—¶å°±æ‰§è¡Œåˆå§‹åŒ–æˆ–è®¾ç½®æ“ä½œæ˜¯å…ƒç±»çš„ä¸€ä¸ªå…¸å‹åº”ç”¨åœºæ™¯ã€‚

æœ¬è´¨ä¸Šè®²ï¼Œä¸€ä¸ªå…ƒç±»ä¼šåœ¨å®šä¹‰æ—¶è¢«è§¦å‘ï¼Œ è¿™æ—¶å€™å¯ä»¥æ‰§è¡Œä¸€äº›é¢å¤–çš„æ“ä½œã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œåˆ©ç”¨è¿™ä¸ªæ€è·¯æ¥åˆ›å»ºç±»ä¼¼äº `collections` æ¨¡å—ä¸­çš„å‘½åå…ƒç»„çš„ç±»ï¼š
```python
import operator

class StructTupleMeta(type):
    def __init__(cls, *args, **kwargs):
        super().__init__(*args, **kwargs)
        for n, name in enumerate(cls._fields):
            setattr(cls, name, property(operator.itemgetter(n)))

class StructTuple(tuple, metaclass=StructTupleMeta):
    _fields = []
    def __new__(cls, *args):
        if len(args) != len(cls._fields):
            raise ValueError('{} arguments required'.format(len(cls._fields)))
        return super().__new__(cls,args)


class Stock(StructTuple):
    _fields = ['name', 'shares', 'price']

class Point(StructTuple):
    _fields = ['x', 'y']


>>> s = Stock('ACME', 50, 91.1)
>>> s
('ACME', 50, 91.1)
>>> s[0]
'ACME'
>>> s.name
'ACME'
>>> s.shares * s.price
4555.0
>>> s.shares = 23
Traceback (most recent call last):
    File "<stdin>", line 1, in <module>
AttributeError: can't set attribute
>>>
```

ç±» `StructTupleMeta` è·å–åˆ°ç±»å±æ€§ `_fields` ä¸­çš„å±æ€§åå­—åˆ—è¡¨ï¼Œ ç„¶åå°†å®ƒä»¬è½¬æ¢æˆç›¸åº”çš„å¯è®¿é—®ç‰¹å®šå…ƒç»„æ§½çš„æ–¹æ³•ã€‚å‡½æ•° `operator.itemgetter()` åˆ›å»ºä¸€ä¸ªè®¿é—®å™¨å‡½æ•°ï¼Œ ç„¶å `property()` å‡½æ•°å°†å…¶è½¬æ¢æˆä¸€ä¸ªå±æ€§ã€‚

è¿™é‡Œæœ€éš¾æ‡‚çš„éƒ¨åˆ†æ˜¯çŸ¥é“ä¸åŒçš„åˆå§‹åŒ–æ­¥éª¤æ˜¯ä»€ä¹ˆæ—¶å€™å‘ç”Ÿçš„ã€‚ `StructTupleMeta` ä¸­çš„ `__init__()` æ–¹æ³•åªåœ¨æ¯ä¸ªç±»è¢«å®šä¹‰æ—¶è¢«è°ƒç”¨ä¸€æ¬¡ã€‚ `cls` å‚æ•°å°±æ˜¯é‚£ä¸ªè¢«å®šä¹‰çš„ç±»ã€‚å®é™…ä¸Šï¼Œä¸Šè¿°ä»£ç ä½¿ç”¨äº† `_fields` ç±»å˜é‡æ¥ä¿å­˜æ–°çš„è¢«å®šä¹‰çš„ç±»ï¼Œ ç„¶åç»™å®ƒå†æ·»åŠ ä¸€ç‚¹æ–°çš„ä¸œè¥¿ã€‚

`StructTuple` ç±»ä½œä¸ºä¸€ä¸ªæ™®é€šçš„åŸºç±»ï¼Œä¾›å…¶ä»–ä½¿ç”¨è€…æ¥ç»§æ‰¿ã€‚ è¿™ä¸ªç±»ä¸­çš„ `__new__()` æ–¹æ³•ç”¨æ¥æ„é€ æ–°çš„å®ä¾‹ã€‚ è¿™é‡Œä½¿ç”¨ `__new__()` å¹¶ä¸æ˜¯å¾ˆå¸¸è§ï¼Œä¸»è¦æ˜¯å› ä¸ºæˆ‘ä»¬è¦ä¿®æ”¹å…ƒç»„çš„è°ƒç”¨ç­¾åï¼Œ ä½¿å¾—æˆ‘ä»¬å¯ä»¥åƒæ™®é€šçš„å®ä¾‹è°ƒç”¨é‚£æ ·åˆ›å»ºå®ä¾‹ã€‚å°±åƒä¸‹é¢è¿™æ ·ï¼š
```python
s = Stock('ACME', 50, 91.1) # OK
s = Stock(('ACME', 50, 91.1)) # Error
```

è·Ÿ `__init__()` ä¸åŒçš„æ˜¯ï¼Œ`__new__()` æ–¹æ³•åœ¨å®ä¾‹è¢«åˆ›å»ºä¹‹å‰è¢«è§¦å‘ã€‚ ç”±äºå…ƒç»„æ˜¯ä¸å¯ä¿®æ”¹çš„ï¼Œæ‰€ä»¥ä¸€æ—¦å®ƒä»¬è¢«åˆ›å»ºäº†å°±ä¸å¯èƒ½å¯¹å®ƒåšä»»ä½•æ”¹å˜ã€‚è€Œ `__init__()` ä¼šåœ¨å®ä¾‹åˆ›å»ºçš„æœ€åè¢«è§¦å‘ï¼Œ è¿™æ ·çš„è¯æˆ‘ä»¬å°±å¯ä»¥åšæˆ‘ä»¬æƒ³åšçš„äº†ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ `__new__()` æ–¹æ³•å·²ç»è¢«å®šä¹‰äº†ã€‚

è¿™éƒ¨åˆ†éœ€è¦æ·±å…¥æ€è€ƒPythonç±»æ˜¯å¦‚ä½•è¢«å®šä¹‰çš„ï¼Œå®ä¾‹æ˜¯å¦‚ä½•è¢«åˆ›å»ºçš„ï¼Œ è¿˜æœ‰å°±æ˜¯å…ƒç±»å’Œç±»çš„å„ä¸ªä¸åŒçš„æ–¹æ³•ç©¶ç«Ÿåœ¨ä»€ä¹ˆæ—¶å€™è¢«è°ƒç”¨ã€‚



### ğŸ æ¨¡å—ä¸åŒ…

ğŸ§© æ„å»ºä¸€ä¸ªæ¨¡å—çš„å±‚çº§åŒ…ã€‚

å°è£…æˆåŒ…æ˜¯å¾ˆç®€å•çš„ã€‚åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šç»„ç»‡ä»£ç ï¼Œå¹¶ç¡®ä¿æ¯ä¸ªç›®å½•éƒ½å®šä¹‰äº†ä¸€ä¸ª `__init__.py` æ–‡ä»¶ã€‚ ä¾‹å¦‚ï¼š
```python
graphics/
    __init__.py
    primitive/
        __init__.py
        line.py
        fill.py
        text.py
    formats/
        __init__.py
        png.py
        jpg.py
```
ä¸€æ—¦åšåˆ°äº†è¿™ä¸€ç‚¹ï¼Œåº”è¯¥èƒ½å¤Ÿæ‰§è¡Œå„ç§ `import` è¯­å¥ï¼Œå¦‚ä¸‹ï¼š
```pyton
import graphics.primitive.line
from graphics.primitive import line
import graphics.formats.jpg as jpg
```

ğŸ§© æ§åˆ¶æ¨¡å—è¢«å…¨éƒ¨å¯¼å…¥çš„å†…å®¹ã€‚
å½“ä½¿ç”¨`from module import *` è¯­å¥æ—¶ï¼Œå¸Œæœ›å¯¹ä»æ¨¡å—æˆ–åŒ…å¯¼å‡ºçš„ç¬¦å·è¿›è¡Œç²¾ç¡®æ§åˆ¶ã€‚åœ¨æ¨¡å—ä¸­å®šä¹‰ä¸€ä¸ªå˜é‡ `__all__` æ¥æ˜ç¡®åœ°åˆ—å‡ºéœ€è¦å¯¼å‡ºçš„å†…å®¹ã€‚
```pyton
# somemodule.py
def spam():
    pass

def grok():
    pass

blah = 42
# Only export 'spam' and 'grok'
__all__ = ['spam', 'grok']
```
å°½ç®¡å¼ºçƒˆåå¯¹ä½¿ç”¨ `from module import *`, ä½†æ˜¯åœ¨å®šä¹‰äº†å¤§é‡å˜é‡åçš„æ¨¡å—ä¸­é¢‘ç¹ä½¿ç”¨ã€‚ å¦‚æœä¸åšä»»ä½•äº‹, è¿™æ ·çš„å¯¼å…¥å°†ä¼šå¯¼å…¥æ‰€æœ‰ä¸ä»¥ä¸‹åˆ’çº¿å¼€å¤´çš„ã€‚ å¦ä¸€æ–¹é¢,å¦‚æœå®šä¹‰äº† `__all__` , é‚£ä¹ˆåªæœ‰è¢«åˆ—ä¸¾å‡ºçš„ä¸œè¥¿ä¼šè¢«å¯¼å‡ºã€‚

å¦‚æœå°† `__all__` å®šä¹‰æˆä¸€ä¸ªç©ºåˆ—è¡¨, æ²¡æœ‰ä¸œè¥¿å°†è¢«å¯¼å…¥ã€‚ å¦‚æœ `__all__` åŒ…å«æœªå®šä¹‰çš„åå­—, åœ¨å¯¼å…¥æ—¶å¼•èµ·`AttributeError`ã€‚

ğŸ§© é‡æ–°åŠ è½½æ¨¡å—ã€‚
æƒ³é‡æ–°åŠ è½½å·²ç»åŠ è½½çš„æ¨¡å—ï¼Œå› ä¸ºæºç è¿›è¡Œäº†ä¿®æ”¹ã€‚ä½¿ç”¨`imp.reload()`æ¥é‡æ–°åŠ è½½å…ˆå‰åŠ è½½çš„æ¨¡å—ã€‚ä¸¾ä¸ªä¾‹å­ï¼š
```python
>>> import spam
>>> import imp
>>> imp.reload(spam)
<module 'spam' from './spam.py'>
>>>
```
é‡æ–°åŠ è½½æ¨¡å—åœ¨å¼€å‘å’Œè°ƒè¯•è¿‡ç¨‹ä¸­å¸¸å¸¸å¾ˆæœ‰ç”¨ã€‚ä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„ä»£ç ä½¿ç”¨ä¼šä¸å®‰å…¨ï¼Œå› ä¸ºå®ƒå¹¶ä¸æ€»æ˜¯åƒæ‚¨æœŸæœ›çš„é‚£æ ·å·¥ä½œã€‚

`reload()`æ“¦é™¤äº†æ¨¡å—åº•å±‚å­—å…¸çš„å†…å®¹ï¼Œå¹¶é€šè¿‡é‡æ–°æ‰§è¡Œæ¨¡å—çš„æºä»£ç æ¥åˆ·æ–°å®ƒã€‚æ¨¡å—å¯¹è±¡æœ¬èº«çš„èº«ä»½ä¿æŒä¸å˜ã€‚å› æ­¤ï¼Œè¯¥æ“ä½œåœ¨ç¨‹åºä¸­æ‰€æœ‰å·²ç»è¢«å¯¼å…¥äº†çš„åœ°æ–¹æ›´æ–°äº†æ¨¡å—ã€‚

